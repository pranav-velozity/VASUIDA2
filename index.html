<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <!-- ⬇️ Set to your Render API base (no trailing slash) -->
  <meta name="api-base" content="https://vasuida1.onrender.com"/>
  <meta name="business-tz" content="Asia/Shanghai"/>
  <title>VelOzity Pinpoint</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    body{background:#f8fafc;color:#111827}
    .vo-nav{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid #eee}
    .vo-wrap{
      max-width:none;
      width:min(96vw,1920px);
      margin:0 auto;
      padding:16px 24px;
      box-sizing:border-box;
    }

    #page-dashboard .cmdbar, #capsules{ min-width:0; flex-wrap:wrap; }

    .dot{width:.6rem;height:.6rem;border-radius:9999px;display:inline-block}
    .heartbeat{animation:heartbeat 1.2s ease-in-out infinite;transform-origin:center}
    @keyframes heartbeat{0%{transform:scale(1)}15%{transform:scale(1.18)}30%{transform:scale(1)}45%{transform:scale(1.12)}60%{transform:scale(1)}100%{transform:scale(1)}}
    .cell{width:100%;padding:.4rem .5rem;border:0;outline:none}
    .cell:focus{box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .th{font-size:.75rem;font-weight:600;color:#374151}
    /* Shorter week capsule */
    .wkcap{border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:.55rem .75rem;width:86px}
    .wkcap .m{font-size:10px}
    .wkcap .d{font-size:16px;font-weight:700;line-height:1.1}
    .wkcap .t{font-size:11px;margin-top:2px;color:#990033}
    .wkcap .bar{height:6px;border-radius:9999px;background:#e5e7eb;overflow:hidden;margin-top:4px}
    .wkcap .bar>div{height:6px;border-radius:9999px;background:#990033;width:0%}

    /* Respect .hidden; only style when visible */
    #page-dashboard:not(.hidden){ display:block; }
    #page-dashboard:not(.hidden) > *{
      position:relative;
      display:block;
      width:100%;
      max-width:100%;
      min-width:0;
      margin-bottom:.75rem;
    }

    /* segmented toggle visuals */
    .seg { color:#9f1239; }
    .seg.active { background:#fff; color:#9f1239; box-shadow:0 1px 2px rgba(16,24,40,.04), 0 1px 3px rgba(16,24,40,.1); }
    .seg:not(.active):hover { background:rgba(225,29,72,.08); }

    /* --- Command Bar (visual only) --- */
    .cmdbar{
      display:flex; flex-wrap:wrap; gap:.25rem;
      padding:.25rem; border-radius:12px;
      background:#fff; border:1px solid #e5e7eb;
      box-shadow:0 1px 2px rgba(16,24,40,.04), 0 1px 3px rgba(16,24,40,.08);
    }
    .cmd{
      display:inline-flex; align-items:center; gap:.5rem;
      font-size:.875rem; line-height:1;
      padding:.5rem .75rem; border-radius:10px;
      border:1px solid transparent; background:transparent; color:#374151;
      transition:background .15s ease, border-color .15s ease, transform .05s ease;
    }
    .cmd:hover{ background:#f9fafb; border-color:#e5e7eb; }
    .cmd:active{ transform:translateY(1px); }
    .cmd:focus-visible{ outline:none; box-shadow:0 0 0 3px rgba(153,0,51,.15); }

    /* variants */
    .cmd--primary{ background:#990033; color:#fff; }
    .cmd--primary:hover{ filter:brightness(.98); }
    .cmd--danger{ color:#991b1b; background:#fff5f5; border-color:#fecaca; }
    .cmd--ghost{ background:transparent; }

    /* icon sizing */
    .cmd svg{ width:16px; height:16px; opacity:.85; }

    :root{
      --brand:#990033;            /* primary */
      --brand-700:#7a0029;
      --brand-100:#fde7ef;        /* soft bg */
      --ink:#111827;
      --muted:#6b7280;
      --accent:#374151;           /* cool gray accent for balance */
    }
    .card{background:#fff;border:1px solid #eee;border-radius:16px;box-shadow:0 1px 2px rgba(16,24,40,.04),0 1px 3px rgba(16,24,40,.08);padding:16px}
    .ct{font-weight:600;color:var(--muted)}
    .brand-soft{background:var(--brand-100);border-color:#f5c6d6}
    .gc{color:var(--muted);text-align:center;margin-top:.25rem}
    .g,.g-sm{display:flex;align-items:center;justify-content:center;min-height:120px}
    .g-sm{min-height:90px}
    .radar-wrap{min-height:320px;display:flex;align-items:center;justify-content:center}
    .seg.active{background:#fff;color:var(--brand);box-shadow:0 1px 2px rgba(16,24,40,.04),0 1px 3px rgba(16,24,40,.1)}
    .seg{color:var(--brand)}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Top Nav -->
  <header class="vo-nav">
    <div class="vo-wrap py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-xl font-semibold">VelOzity Pinpoint</div>
        <div id="vo-today" class="text-gray-500 text-sm"></div>
      </div>
      <nav id="nav-toggle" class="inline-flex items-center gap-1 p-1 rounded-xl bg-rose-50 border border-rose-200">
        <a href="#dashboard" id="nav-dash"
           class="seg px-3 py-1.5 rounded-lg text-sm font-medium transition select-none">
          Operations
        </a>
        <a href="#intake" id="nav-intake"
           class="seg px-3 py-1.5 rounded-lg text-sm font-medium transition select-none">
          Intake
        </a>
        <a href="#exec" id="nav-exec"
           class="seg px-3 py-1.5 rounded-lg text-sm font-medium transition select-none">
          Executive
        </a>
      </nav>
    </div>
  </header>

  <main class="vo-wrap py-4">
    <!-- ================= Operations ================= -->
    <section id="page-dashboard" class="hidden">
      <div class="flex items-center justify-between mb-2 basis-full w-full">
        <div class="text-2xl font-semibold">Operations</div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Week start</label>
          <input id="week-start" type="date" class="px-2 py-1 border rounded-md text-sm"/>

          <input id="file-plan" type="file" accept=".xlsx,.csv" class="hidden"/>

          <div class="cmdbar" role="group" aria-label="Operations actions">
            <button id="btn-upload-plan" class="cmd cmd--primary" aria-label="Upload Plan" title="Upload planned PO×SKU for the selected week">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true" focusable="false"> 
                <path d="M12 3v12m0-12 4 4m-4-4-4 4M4 17h16v2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Upload Plan
            </button>
            <button id="btn-zero-plan" class="cmd cmd--danger" aria-label="Zero Plan" title="Clear the plan for this week">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true" focusable="false"><path d="M6 18L18 6M6 6l12 12" stroke-width="1.5" stroke-linecap="round"/></svg>
              Zero Plan
            </button>
          </div>
        </div>
      </div>

      <!-- Capsules + Actions -->
      <div class="mb-3 flex flex-wrap items-start gap-3 basis-full w-full">
        <div id="capsules" class="flex flex-wrap items-center gap-3 flex-1 min-w-[320px]"></div>
        <div class="cmdbar shrink-0" role="group" aria-label="Reports and downloads">
          <button id="btn-dl-posku" class="cmd cmd--ghost" aria-label="PO × SKU Discrepancy" title="Compare planned vs applied at PO×SKU level">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true" focusable="false">
              <path d="M3 5h18M3 12h18M3 19h18" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            PO × SKU Discrepancy
          </button>

          <button id="btn-dl-po" class="cmd cmd--ghost" aria-label="PO Discrepancy" title="Compare planned vs applied at PO level">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true" focusable="false">
              <path d="M4 6h16M4 12h10M4 18h7" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            PO Discrepancy
          </button>

          <button id="btn-exec" class="cmd" aria-label="Executive Summary" title="Generate weekly Executive Summary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true" focusable="false">
              <path d="M7 4h10a2 2 0 0 1 2 2v12l-4-2-4 2-4-2-4 2V6a2 2 0 0 1 2-2z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Executive Summary
          </button>

          <button id="btn-dl-week-applied" class="cmd cmd--ghost" aria-label="Download Applied" title="Export applied UIDs for this week">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true" focusable="false">
              <path d="M12 3v12m0 0 4-4m-4 4-4-4M4 19h16" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Download Applied
          </button>
        </div>
      </div>

      <!-- KPI tiles -->
      <div class="w-full basis-full grid grid-cols-1 sm:grid-cols-5 gap-3 mb-3">
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold text-gray-600">Planned</div>
          <div class="text-xs text-gray-500" id="planned-range"></div>
          <div class="text-2xl font-bold tabular-nums" id="planned-total">0</div>
        </div>
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold text-gray-600">Applied</div>
          <div class="text-xs text-gray-500" id="applied-range"></div>
          <div class="text-2xl font-bold tabular-nums" id="applied-total">0</div>
        </div>
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold text-gray-600">Completion</div>
          <div class="text-xs text-gray-500">&nbsp;</div>
          <div class="text-2xl font-bold tabular-nums" id="pct-week">0%</div>
        </div>
        <div class="bg-white rounded-2xl border shadow p-4 flex items-center gap-4">
          <div id="ops-heart"></div>
          <div>
            <div class="text-base font-semibold text-gray-600">Ops Pulse</div>
            <div class="text-xl font-bold tabular-nums" id="ops-bpm">0</div>
            <div class="text-[11px] text-gray-500" id="ops-extra">+0 over 40</div>
          </div>
        </div>
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold text-gray-600">Applied averages</div>
          <div class="text-xs text-gray-500 mb-1">&nbsp;</div>
          <div class="text-2xl font-bold tabular-nums" id="avg-day">0</div>
          <div class="text-xs text-gray-500 mt-1">Avg/day • <span id="avg-week">0</span></div>
        </div>
      </div>

      <!-- Search -->
      <div class="w-full basis-full bg-white rounded-2xl border shadow p-4 mb-3">
        <div class="text-base font-semibold mb-2">Search by PO or SKU</div>
        <input id="search-input" type="search" aria-label="Search by PO or SKU" placeholder="Type a PO # or SKU Code and pause…" class="w-full border rounded-md px-3 py-2 text-sm outline-none focus:ring-2">
        <div id="search-results" class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3 hidden"></div>
      </div>

      <!-- Top Insights -->
      <div class="w-full basis-full min-w-0 rounded-2xl border shadow p-4 mb-3 text-white" style="background:#990033;border-color:#7a0029">
        <div class="text-base font-semibold mb-2">Top Insights for Ops</div>
        <ul id="insights" class="text-sm text-white list-disc pl-5 space-y-1" aria-live="polite">
          <li>Loading…</li>
        </ul>
        <div id="insights-mini" class="mt-2 text-xs text-rose-100"></div>
      </div>

      <!-- PO Progress (This Week) -->
      <div class="w-full basis-full min-w-0 bg-white rounded-2xl border shadow p-4 mb-3">
        <div class="text-base font-semibold mb-2">PO Progress (This Week)</div>
        <div class="overflow-auto max-h-[480px]">
          <table class="w-full text-sm" id="po-progress">
            <thead>
              <tr class="text-gray-500">
                <th scope="col" class="text-left py-1 pr-2">PO #</th>
                <th scope="col" class="text-left py-1 pr-2">Due</th>
                <th scope="col" class="text-right py-1 pr-2">Planned</th>
                <th scope="col" class="text-right py-1 pr-2">Applied</th>
                <th scope="col" class="text-right py-1">%</th>
              </tr>
            </thead>
            <tbody id="po-progress-body">
              <tr><td colspan="5" class="text-center text-xs text-gray-400 py-3">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Risks -->
      <div class="w-full basis-full min-w-0 grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
        <!-- Top PO's at Risk -->
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold mb-2">Top POs at Risk</div>
          <table class="w-full text-sm">
            <thead>
              <tr class="text-gray-500">
                <th class="text-left py-1 pr-2">PO #</th>
                <th class="text-left py-1 pr-2">Due</th>
                <th class="text-right py-1 pr-2">Planned</th>
                <th class="text-right py-1 pr-2">Applied</th>
                <th class="text-right py-1 pr-2">Rem</th>
                <th class="text-right py-1">%</th>
              </tr>
            </thead>
            <tbody id="risk-po-body">
              <tr><td colspan="6" class="text-center text-xs text-gray-400 py-3">Loading…</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Top SKU's at Risk -->
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold mb-2">Top SKUs at Risk</div>
          <table class="w-full text-sm">
            <thead>
              <tr class="text-gray-500">
                <th class="text-left py-1 pr-2">SKU</th>
                <th class="text-left py-1 pr-2">Due</th>
                <th class="text-right py-1 pr-2">Planned</th>
                <th class="text-right py-1 pr-2">Applied</th>
                <th class="text-right py-1 pr-2">Rem</th>
                <th class="text-right py-1">%</th>
              </tr>
            </thead>
            <tbody id="risk-sku-body">
              <tr><td colspan="6" class="text-center text-xs text-gray-400 py-3">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ================= UID Intake ================= -->
    <section id="page-intake" class="hidden">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-5">
          <div class="text-2xl font-semibold">UID Intake (Table Mode)</div>
          <div class="flex items-center gap-2 bg-white border rounded-xl px-3 py-2">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" width="18" height="18" class="heartbeat">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" fill="#990033"/>
            </svg>
            <div class="text-sm"><span class="font-semibold">Ops</span> • <span id="intake-bpm">0</span> bpm</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btn-export-day" class="px-3 py-2 rounded-lg text-sm border" aria-label="Export XLSX">Export XLSX</button>
          <button id="btn-upload-applied" class="px-3 py-2 rounded-lg text-sm border" aria-label="Upload UIDs">Upload UIDs</button>
          <button id="btn-upload-bins" class="px-3 py-2 rounded-lg text-sm border" aria-label="Upload Bin Manifest">Upload Bin Manifest</button>
          <input id="file-bins" type="file" accept=".xlsx,.csv" class="hidden"/>
          <input id="file-upload-applied" type="file" accept=".xlsx,.csv" class="hidden"/>
          <button id="btn-delete-selected" class="px-3 py-2 rounded-lg text-sm border border-rose-700 text-rose-700" aria-label="Delete Selected">Delete Selected</button>
        </div>
      </div>

      <!-- KPI rings -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
        <div class="card brand-soft"><div id="g-week" class="g"></div><div class="gc">Week Completion</div></div>
        <div class="card brand-soft"><div id="g-due3" class="g"></div><div class="gc">Due ≤3d</div></div>
        <div class="card brand-soft"><div id="g-quality" class="g"></div><div class="gc">Data Quality</div></div>
      </div>

      <!-- Radar + Bin QA -->
      <div class="grid grid-cols-1 lg:grid-cols-[1fr_360px] gap-3">
        <div class="card">
          <div class="ct">Risk Profile</div>
          <div id="radar" class="radar-wrap"></div>
          <div class="cap text-xs text-gray-500 mt-2">Axes: Plan • ≤3d • Quality • Sync • Bin QA • On-Time</div>
        </div>

        <div class="card">
          <div class="ct">Bin QA</div>
          <div id="binqa-line" class="text-sm mt-1"></div>
          <div class="mt-3 brand-soft rounded-xl p-3">
            <div id="g-manifest" class="g-sm"></div>
            <div class="gc text-xs">Manifest Coverage</div>
          </div>
        </div>
      </div>

      <!-- ⬇️⬇️ Intake-only blocks moved INSIDE the Intake section (fixes cross-page overlap) -->
      <!-- Ops ribbon -->
      <div id="ops-ribbon" class="mt-3 bg-white border rounded-xl shadow p-3">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-stretch">
          <div class="flex gap-3">
            <div class="flex-1 border rounded-lg p-3">
              <div class="text-xs text-gray-500">Scans Today</div>
              <div id="ops-today" class="text-2xl font-bold tabular-nums">0</div>
            </div>
            <div class="flex-1 border rounded-lg p-3">
              <div class="text-xs text-gray-500">Last Hour</div>
              <div id="ops-hour" class="text-2xl font-bold tabular-nums">0</div>
            </div>
          </div>
          <div class="flex items-center gap-4 border rounded-lg p-3">
            <div id="ops-heart-small"></div>
            <div>
              <div class="text-xs text-gray-500">Throughput / hr (last 30m)</div>
              <div id="ops-rate" class="text-2xl font-bold tabular-nums">0</div>
            </div>
          </div>
          <div class="border rounded-lg p-3">
            <div class="text-sm font-semibold mb-1">Data Quality</div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-500">Drafts</span><strong id="ops-drafts">0</strong>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-500">Duplicates</span><strong id="ops-dupes">0</strong>
            </div>
            <div class="text-xs text-gray-500 mt-2">Sync states</div>
            <div id="ops-sync-badges" class="flex flex-wrap gap-2 mt-1"></div>
          </div>
          <div class="border rounded-lg p-3">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">Alerts</div>
              <small class="text-gray-500">
                <span id="ops-last-updated">—</span>
                <span class="inline-flex items-center gap-1 border rounded-full px-2 py-0.5 text-[11px] text-gray-500">
                  <span id="ops-dot" class="w-2 h-2 rounded-full bg-gray-300"></span>SSE
                </span>
              </small>
            </div>
            <ul id="ops-alerts" class="list-disc ml-4 mt-1 text-sm" aria-live="polite"><li class="text-gray-400">No alerts.</li></ul>
          </div>
        </div>
      </div>

      <!-- Intake Table -->
      <div class="mt-3 overflow-auto">
        <table class="w-full min-w-[1100px] border-collapse border">
          <thead class="bg-gray-100">
            <tr>
              <th class="th border px-2 py-1 text-left w-8"><input type="checkbox" id="chk-all"/></th>
              <th class="th border px-2 py-1 text-left">Date</th>
              <th class="th border px-2 py-1 text-left">Mobile Bin (BOX)</th>
              <th class="th border px-2 py-1 text-left">SSCC Label (BOX)</th>
              <th class="th border px-2 py-1 text-left">PO_Number</th>
              <th class="th border px-2 py-1 text-left">SKU_Code</th>
              <th class="th border px-2 py-1 text-left">UID</th>
              <th class="th border px-2 py-1 text-center">Sync</th>
            </tr>
          </thead>
          <tbody id="intake-body"></tbody>
        </table>
      </div>

      <div class="mt-3">
        <button id="btn-add-row" class="px-3 py-2 rounded-lg border text-sm">Add Row</button>
      </div>

      <!-- Quick Delete by UID -->
      <div class="mt-4 bg-white rounded-2xl border shadow p-4">
        <div class="text-base font-semibold mb-2">Delete Applied UID(s)</div>
        <p class="text-xs text-gray-500 mb-2">
          Enter one or more UIDs (comma, space, or line separated). The system will remove matching records.
        </p>
        <textarea id="uids-to-delete" rows="3" placeholder="Paste UIDs here…" class="w-full border rounded-md px-3 py-2 text-sm outline-none focus:ring-2"></textarea>
        <div class="mt-2 flex items-center gap-2">
          <button id="btn-delete-uids" class="px-3 py-2 rounded-lg border border-rose-700 text-rose-700">Delete UID(s)</button>
          <span id="delete-uids-status" class="text-xs text-gray-500"></span>
        </div>
      </div>
      <!-- ⬆️⬆️ Intake-only blocks end -->
    </section>

    <!-- ================= Executive (Client) ================= -->
    <section id="page-exec" class="hidden">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div class="text-2xl font-semibold">Executive Summary</div>
          <div id="exec-sub" class="text-xs text-rose-900/70 mt-0.5"></div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btn-exec-doc" class="cmd cmd--primary">Download .doc</button>
          <button id="btn-exec-csv" class="cmd">PO×SKU CSV</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer health pill (shows Applied this week) -->
  <div id="vo-footer" style="position:fixed;left:0;right:0;bottom:0;z-index:50;font-size:12px;background:transparent;padding:.5rem .75rem;display:flex;gap:.75rem;align-items:center;">
    <span id="health-pill" class="inline-flex items-center gap-2 px-3 py-1 rounded-full border bg-amber-100 text-amber-900 border-amber-300">
      <span id="health-dot" class="inline-block w-2 h-2 rounded-full bg-amber-500"></span>
      Health: <span id="vo-health" class="ml-1">n/a</span>
    </span>
    <span id="vo-footer-text">Applied this week: 0</span>
  </div>

  <!-- =================== JS (unchanged logic; only routing tightened) =================== -->
  <script>
  /* ——— your original script below; unchanged except:
     1) Intake-only blocks moved; no JS edits needed for them.
     2) Initial routing: if NO hash present, we set #exec once. ——— */

  const BRAND = '#990033';
  const BASE_BPM = 40;
  const apiBase = (document.querySelector('meta[name="api-base"]')?.content || '').replace(/\/+$/,'');
  const $ = (s)=>document.querySelector(s);

  // Show "Month DD YYYY • <local TZ>"
  (function setNavToday(){
    const d = new Date();
    const month = d.toLocaleString('en-US', { month: 'long' });
    const day   = String(d.getDate()).padStart(2, '0');
    const year  = d.getFullYear();
    const tzShort = new Intl.DateTimeFormat('en-US', { timeZoneName: 'short' })
      .formatToParts(d)
      .find(p => p.type === 'timeZoneName')?.value || '';
    $('#vo-today').textContent = `${month} ${day} ${year} • ${tzShort}`;
  })();

  /* …………… (ALL of your original JS remains exactly the same) …………… */
  /* For brevity here, keep your full original <script> content from your message.
     I have not modified any functions, except the tiny init change shown below. */

  /* === The ONLY behavioral tweak: initial routing default === */
  (function init(){
    const ws = (typeof mondayOfInTZ === 'function')
  ? mondayOfInTZ(todayInTZ())
  : iso(mondayOf(new Date())); // fallback: compute Monday in viewer’s local TZ
    $('#week-start').value = ws;
    setWeek(ws);

    const weekInput = document.getElementById('week-start');
    weekInput?.addEventListener('change', (e) => {
      const v = String(e.target.value || '').trim();
      if (v) setWeek(v);
    });

    function syncNav() {
      const hash = (location.hash || '#dashboard');

      const dash   = document.getElementById('nav-dash');
      const intake = document.getElementById('nav-intake');
      const exec   = document.getElementById('nav-exec');

      if (!dash || !intake || !exec) return;

      [dash, intake, exec].forEach(el => {
        el.classList.remove('active');
        el.removeAttribute('aria-current');
      });

      if (hash === '#intake') {
        intake.classList.add('active');
        intake.setAttribute('aria-current', 'page');
      } else if (hash === '#exec') {
        exec.classList.add('active');
        exec.setAttribute('aria-current', 'page');
      } else {
        dash.classList.add('active');
        dash.setAttribute('aria-current', 'page');
      }
    }

    function show(hash) {
      document.getElementById('page-dashboard')?.classList.add('hidden');
      document.getElementById('page-intake')?.classList.add('hidden');
      document.getElementById('page-exec')?.classList.add('hidden');

      if (hash === '#intake') {
        document.getElementById('page-intake')?.classList.remove('hidden');
      } else if (hash === '#exec') {
        document.getElementById('page-exec')?.classList.remove('hidden');

        // (Executive subtitle + gauges; original code unchanged)
        try {
          const ws = state.weekStart;
          const weD = new Date(ws); weD.setDate(weD.getDate() + 6);
          const we = iso(weD);
          const sub = document.getElementById('exec-sub');
          if (sub) sub.textContent = `${ws} – ${we}`;

          // reuse existing calculations & renderExecutiveWidgets (all your code above)
          const plannedTotal = (state.plan || []).reduce((s,p)=> s + toNum(p.target_qty), 0);
          const appliedTotal = (state.records || []).filter(r => r.status === 'complete').length;
          const pct = plannedTotal > 0 ? Math.round(appliedTotal * 100 / plannedTotal) : ((state.plan||[]).length ? 0 : 100);

          // … your due3Pct / qualityPct / qa calc (unchanged) …
          // (left intact in your full script)

          renderExecutiveWidgets?.({ pct, due3Pct, qualityPct, qa });
        } catch {}
        wireExecButtonsOnce();
      } else {
        document.getElementById('page-dashboard')?.classList.remove('hidden');
      }

      syncNav();
    }

    // Ensure default landing is Executive only when there's NO hash
    if (!location.hash) location.hash = '#exec';

    window.addEventListener('hashchange', () => show(location.hash || '#exec'));
    show(location.hash || '#exec');

    // Intake scaffold + checkbox handler (unchanged)
    renderIntake();
    document.getElementById('chk-all')?.addEventListener('change', (e) => {
      const on = e.target.checked;
      intakeRows.forEach(r => r.selected = on);
      renderIntake();
      document.getElementById('chk-all').checked = on;
    });

    document.getElementById('btn-delete-uids')?.addEventListener('click', deleteUIDs);

    // pulse hearts + metrics
    $('#ops-heart').appendChild(createHeart(24, BRAND, 40));
    $('#ops-heart-small').appendChild(createHeart(18, BRAND, 40));
    loadOpsMetrics();
    startSSE();
  })();
  </script>
</body>
</html>