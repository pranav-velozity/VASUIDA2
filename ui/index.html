<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <!-- ⬇️ Set to your Render API base (no trailing slash) -->
  <meta name="api-base" content="https://vasuida1.onrender.com"/>
  <title>VelOzity Pinpoint</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS for XLSX parsing -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    body{background:#f8fafc;color:#111827}
    .vo-nav{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid #eee}
    .container{max-width:none;width:min(96vw,1920px);margin:0 auto;padding:16px 24px}
    .dot{width:.6rem;height:.6rem;border-radius:9999px;display:inline-block}
    .heartbeat{animation:heartbeat 1.2s ease-in-out infinite;transform-origin:center}
    @keyframes heartbeat{0%{transform:scale(1)}15%{transform:scale(1.18)}30%{transform:scale(1)}45%{transform:scale(1.12)}60%{transform:scale(1)}100%{transform:scale(1)}}
    .cell{width:100%;padding:.4rem .5rem;border:0;outline:none}
    .cell:focus{box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .th{font-size:.75rem;font-weight:600;color:#374151}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Top Nav -->
  <header class="vo-nav">
    <div class="container py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-xl font-semibold">VelOzity Pinpoint</div>
        <div id="vo-today" class="text-gray-500 text-sm"></div>
      </div>
      <nav class="flex items-center gap-2">
        <a href="#dashboard" id="nav-dash"   class="px-3 py-2 rounded-lg text-sm font-medium border border-rose-700 text-rose-700">Active Plan</a>
        <a href="#intake"    id="nav-intake" class="px-3 py-2 rounded-lg text-sm font-medium border border-rose-700 text-rose-700/80">Intake</a>
      </nav>
    </div>
  </header>

  <main class="container py-4">
    <!-- ================= Active Plan ================= -->
    <section id="page-dashboard" class="hidden">
      <div class="flex items-center justify-between mb-2">
        <div class="text-2xl font-semibold">Active Plan</div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Week start</label>
          <input id="week-start" type="date" class="px-2 py-1 border rounded-md text-sm"/>
          <input id="file-plan" type="file" accept=".csv" class="hidden"/>
          <button id="btn-upload-plan" class="px-3 py-2 rounded-lg text-sm border">Upload Plan</button>
          <button id="btn-zero-plan"   class="px-3 py-2 rounded-lg text-sm border">Zero Plan</button>
        </div>
      </div>

      <!-- Capsules -->
      <div id="capsules" class="hidden sm:flex items-center gap-3 mb-3"></div>

      <!-- KPI tiles -->
      <div class="grid grid-cols-1 sm:grid-cols-5 gap-3 mb-3">
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold text-gray-600">Planned</div>
          <div class="text-xs text-gray-500" id="planned-range"></div>
          <div class="text-2xl font-bold tabular-nums" id="planned-total">0</div>
        </div>
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold text-gray-600">Applied</div>
          <div class="text-xs text-gray-500" id="applied-range"></div>
          <div class="text-2xl font-bold tabular-nums" id="applied-total">0</div>
        </div>
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold text-gray-600">Completion</div>
          <div class="text-xs text-gray-500">&nbsp;</div>
          <div class="text-2xl font-bold tabular-nums" id="pct-week">0%</div>
        </div>
        <div class="bg-white rounded-2xl border shadow p-4 flex items-center gap-4">
          <div id="ops-heart"></div>
          <div>
            <div class="text-base font-semibold text-gray-600">Ops Pulse</div>
            <div class="text-xl font-bold tabular-nums" id="ops-bpm">0</div>
            <div class="text-[11px] text-gray-500" id="ops-extra">+0 over 40</div>
          </div>
        </div>
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold text-gray-600">Applied averages</div>
          <div class="text-xs text-gray-500 mb-1">&nbsp;</div>
          <div class="text-2xl font-bold tabular-nums" id="avg-day">0</div>
          <div class="text-xs text-gray-500 mt-1">Avg/day • <span id="avg-week">0</span></div>
        </div>
      </div>

      <!-- Search -->
      <div class="bg-white rounded-2xl border shadow p-4 mb-3">
        <div class="text-base font-semibold mb-2">Search by PO or SKU</div>
        <input id="search-input" type="search" placeholder="Type a PO # or SKU Code and pause…" class="w-full border rounded-md px-3 py-2 text-sm outline-none focus:ring-2">
        <div id="search-results" class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3 hidden"></div>
      </div>

      <!-- PO Progress -->
      <div class="bg-white rounded-2xl border shadow p-4 mb-3">
        <div class="text-base font-semibold mb-2">PO Progress (This Week)</div>
        <div class="overflow-auto max-h-[480px]">
          <table class="w-full text-sm" id="po-progress">
            <thead>
            <tr class="text-gray-500">
              <th class="text-left py-1 pr-2">PO #</th>
              <th class="text-left py-1 pr-2">Due</th>
              <th class="text-right py-1 pr-2">Planned</th>
              <th class="text-right py-1 pr-2">Applied</th>
              <th class="text-right py-1">%</th>
            </tr>
            </thead>
            <tbody id="po-progress-body"><tr><td colspan="5" class="text-center text-xs text-gray-400 py-3">Loading…</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Risks -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold mb-2">Top PO's at Risk</div>
          <table class="w-full text-sm" id="risk-po">
            <thead>
            <tr class="text-gray-500">
              <th class="text-left py-1 pr-2">PO #</th>
              <th class="text-left py-1 pr-2">Due</th>
              <th class="text-right py-1 pr-2">Planned</th>
              <th class="text-right py-1 pr-2">Applied</th>
              <th class="text-right py-1 pr-2">Rem</th>
              <th class="text-right py-1">%</th>
            </tr>
            </thead>
            <tbody id="risk-po-body"><tr><td colspan="6" class="text-center text-xs text-gray-400 py-3">Loading…</td></tr></tbody>
          </table>
        </div>
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold mb-2">Top SKU's at Risk</div>
          <table class="w-full text-sm" id="risk-sku">
            <thead>
            <tr class="text-gray-500">
              <th class="text-left py-1 pr-2">SKU</th>
              <th class="text-left py-1 pr-2">Due</th>
              <th class="text-right py-1 pr-2">Planned</th>
              <th class="text-right py-1 pr-2">Applied</th>
              <th class="text-right py-1 pr-2">Rem</th>
              <th class="text-right py-1">%</th>
            </tr>
            </thead>
            <tbody id="risk-sku-body"><tr><td colspan="6" class="text-center text-xs text-gray-400 py-3">Loading…</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ================= UID Intake ================= -->
    <section id="page-intake" class="hidden">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-5">
          <div class="text-2xl font-semibold">UID Intake (Table Mode)</div>
          <div class="flex items-center gap-2 bg-white border rounded-xl px-3 py-2">
            <svg viewBox="0 0 24 24" width="18" height="18" class="heartbeat">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" fill="#990033"/>
            </svg>
            <div class="text-sm"><span class="font-semibold">Ops</span> • <span id="intake-bpm">0</span> bpm</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btn-export-day" class="px-3 py-2 rounded-lg text-sm border">Export XLSX</button>
          <button id="btn-upload-applied" class="px-3 py-2 rounded-lg text-sm border">Upload UIDs</button>
          <input id="file-upload-applied" type="file" accept=".xlsx,.csv" class="hidden"/>
          <button id="btn-delete-selected" class="px-3 py-2 rounded-lg text-sm border border-rose-700 text-rose-700">Delete Selected</button>
        </div>
      </div>

      <!-- Ops ribbon -->
      <div id="ops-ribbon" class="mt-3 bg-white border rounded-xl shadow p-3">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-stretch">
          <div class="flex gap-3">
            <div class="flex-1 border rounded-lg p-3">
              <div class="text-xs text-gray-500">Scans Today</div>
              <div id="ops-today" class="text-2xl font-bold tabular-nums">0</div>
            </div>
            <div class="flex-1 border rounded-lg p-3">
              <div class="text-xs text-gray-500">Last Hour</div>
              <div id="ops-hour" class="text-2xl font-bold tabular-nums">0</div>
            </div>
          </div>
          <div class="flex items-center gap-4 border rounded-lg p-3">
            <div id="ops-heart-small"></div>
            <div>
              <div class="text-xs text-gray-500">Throughput / hr (last 30m)</div>
              <div id="ops-rate" class="text-2xl font-bold tabular-nums">0</div>
            </div>
          </div>
          <div class="border rounded-lg p-3">
            <div class="text-sm font-semibold mb-1">Data Quality</div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-500">Drafts</span><strong id="ops-drafts">0</strong>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-500">Duplicates</span><strong id="ops-dupes">0</strong>
            </div>
            <div class="text-xs text-gray-500 mt-2">Sync states</div>
            <div id="ops-sync-badges" class="flex flex-wrap gap-2 mt-1"></div>
          </div>
          <div class="border rounded-lg p-3">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">Alerts</div>
              <small class="text-gray-500">
                <span id="ops-last-updated">—</span>
                <span class="inline-flex items-center gap-1 border rounded-full px-2 py-0.5 text-[11px] text-gray-500">
                  <span id="ops-dot" class="w-2 h-2 rounded-full bg-gray-300"></span>SSE
                </span>
              </small>
            </div>
            <ul id="ops-alerts" class="list-disc ml-4 mt-1 text-sm"><li class="text-gray-400">No alerts.</li></ul>
          </div>
        </div>
      </div>

      <!-- Intake Table -->
      <div class="mt-3 overflow-auto">
        <table class="w-full min-w-[1100px] border-collapse border">
          <thead class="bg-gray-100">
          <tr>
            <th class="th border px-2 py-1 text-left w-8"><input type="checkbox" id="chk-all"/></th>
            <th class="th border px-2 py-1 text-left">Date</th>
            <th class="th border px-2 py-1 text-left">Mobile Bin (BOX)</th>
            <th class="th border px-2 py-1 text-left">SSCC Label (BOX)</th>
            <th class="th border px-2 py-1 text-left">PO_Number</th>
            <th class="th border px-2 py-1 text-left">SKU_Code</th>
            <th class="th border px-2 py-1 text-left">UID</th>
            <th class="th border px-2 py-1 text-center">Sync</th>
          </tr>
          </thead>
          <tbody id="intake-body"></tbody>
        </table>
      </div>

      <div class="mt-3">
        <button id="btn-add-row" class="px-3 py-2 rounded-lg border text-sm">Add Row</button>
      </div>
    </section>
  </main>

  <!-- Footer health pill -->
  <div id="vo-footer" style="position:fixed;left:0;right:0;bottom:0;z-index:50;font-size:12px;background:transparent;padding:.5rem .75rem;display:flex;gap:.75rem;align-items:center;">
    <span id="health-pill" class="inline-flex items-center gap-2 px-3 py-1 rounded-full border bg-amber-100 text-amber-900 border-amber-300">
      <span id="health-dot" class="inline-block w-2 h-2 rounded-full bg-amber-500"></span>
      Health: <span id="vo-health" class="ml-1">n/a</span>
    </span>
    <span id="vo-footer-text">Planned total is 0.</span>
  </div>

  <script>
  const BRAND = '#990033';
  const apiBase = (document.querySelector('meta[name="api-base"]')?.content || '').replace(/\/+$/,'');
  const $ = (s)=>document.querySelector(s);
  $('#vo-today').textContent = new Date().toLocaleDateString();

  // ---------- helpers ----------
  const iso=(d)=>d.toISOString().slice(0,10);
  const mondayOf=(d=new Date())=>{const x=new Date(d);const day=x.getDay();const diff=(day===0?-6:1)-day;x.setDate(x.getDate()+diff);x.setHours(0,0,0,0);return x;}
  const fmtInt=(n)=>Number(n||0).toLocaleString();
  function createHeart(size=24,color=BRAND,bpm=40){const s='http://www.w3.org/2000/svg',svg=document.createElementNS(s,'svg');svg.setAttribute('viewBox','0 0 24 24');svg.setAttribute('width',size);svg.setAttribute('height',size);const p=document.createElementNS(s,'path');p.setAttribute('d','M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z');p.setAttribute('fill',color);svg.appendChild(p);svg.classList.add('heartbeat');svg.style.animationDuration=`${(60/Math.max(40,bpm)).toFixed(2)}s`;return svg;}

  // ---------- API ----------
  const state={weekStart:iso(mondayOf()), plan:[], records:[]};
  async function api(path,opts={}){const r=await fetch(`${apiBase}${path}`,{method:opts.method||'GET',headers:{'Content-Type':'application/json'},body:opts.body?JSON.stringify(opts.body):undefined}); if(!r.ok) throw new Error(await r.text()); const ct=r.headers.get('content-type')||''; return ct.includes('json')?r.json():r.text();}
  async function fetchPlan(w){ if(!apiBase) return []; try{return await api(`/plan/weeks/${w}`);}catch{return [];} }
  async function fetchActuals(f,t){ if(!apiBase) return []; try{const d=await api(`/records?from=${f}&to=${t}&status=complete&limit=50000`); return d.records||[];}catch{return [];} }

  // ---------- capsules ----------
  function addDaysISO(s,days){const [y,m,d]=s.split('-').map(Number);const b=new Date(y,m-1,d);b.setDate(b.getDate()+days);return b.toISOString().slice(0,10)}
  function renderCapsules(baseISO){
    const r=$('#capsules'); if(!r) return;
    r.classList.remove('hidden'); r.innerHTML='';
    const list=[-7,0,7,14,21].map(n=>addDaysISO(baseISO,n));
    list.forEach(id=>{
      const d=new Date(id+'T00:00:00');
      const day=String(d.getDate()).padStart(2,'0');
      const mon=d.toLocaleString('en-US',{month:'short'}).toUpperCase().slice(0,3);
      const btn=document.createElement('button');
      btn.className='rounded-xl border px-3 py-2 w-[96px] text-left bg-white hover:scale-[1.02] transition';
      btn.style.borderColor = (id===state.weekStart? BRAND : 'rgba(0,0,0,.12)');
      btn.innerHTML=`<div class="text-[10px]" style="color:${id===state.weekStart?BRAND:'#6b7280'}">${mon}</div>
                     <div class="text-lg font-semibold leading-5">${day}</div>
                     <div id="cap-total-${id}" class="text-[11px] mt-0.5" style="color:${BRAND}">0</div>
                     <div class="mt-1 h-1.5 rounded-full bg-gray-200 overflow-hidden">
                       <div id="cap-bar-${id}" class="h-1.5 rounded-full" style="width:0%;background:${BRAND}"></div>
                     </div>`;
      btn.onclick=()=>{ $('#week-start').value=id; setWeek(id); };
      r.appendChild(btn);
    });
  }

  // ---------- dashboard metrics ----------
  function aggregate(records){const byPO=new Map(), bySKU=new Map(); for(const r of records){ if(r.status!=='complete') continue; const po=String(r.po_number||'').trim(), sku=String(r.sku_code||'').trim(); if(po) byPO.set(po,(byPO.get(po)||0)+1); if(sku) bySKU.set(sku,(bySKU.get(sku)||0)+1);} return {byPO,bySKU};}
  function setFooterTiles(ws,we,plan,records){
    const agg=aggregate(records);
    const plannedTotal=(plan||[]).reduce((s,p)=>s+Number(p.target_qty||0),0);
    const appliedTotal=Array.from(agg.byPO.values()).reduce((s,v)=>s+v,0);
    const pct=plannedTotal>0?Math.round(appliedTotal*100/plannedTotal):(plan.length?0:100);
    $('#planned-range').textContent=`${ws} – ${we}`;
    $('#applied-range').textContent=`${ws} – ${we}`;
    $('#planned-total').textContent=plannedTotal.toLocaleString();
    $('#applied-total').textContent=appliedTotal.toLocaleString();
    $('#pct-week').textContent=pct+'%';
    $('#avg-week').textContent=appliedTotal.toLocaleString();
    $('#avg-day').textContent=Math.round((appliedTotal||0)/7).toLocaleString();
  }

  async function refreshDashboardTotals(){
    if(!apiBase) return;
    const ws=state.weekStart;
    const start=new Date(ws+'T00:00:00Z');
    const end=new Date(start); end.setDate(end.getDate()+7);

    const res=await fetch(`${apiBase}/records?limit=50000`);
    if(!res.ok) return;
    const all=(await res.json()).records||[];

    const inWeek=all.filter(r=>{
      if(r.status!=='complete'||!r.completed_at) return false;
      const t=new Date(r.completed_at).getTime();
      return t>=start.getTime() && t<end.getTime();
    });

    const plannedTotal=(state.plan||[]).reduce((s,p)=>s+Number(p.target_qty||0),0);
    const appliedTotal=inWeek.length;

    const we = new Date(end); we.setDate(we.getDate()-1);
    $('#planned-range').textContent = `${ws} – ${we.toISOString().slice(0,10)}`;
    $('#applied-range').textContent = `${ws} – ${we.toISOString().slice(0,10)}`;
    $('#planned-total').textContent = plannedTotal.toLocaleString();
    $('#applied-total').textContent = appliedTotal.toLocaleString();
    const pct = plannedTotal>0?Math.round(appliedTotal*100/plannedTotal):(state.plan.length?0:100);
    $('#pct-week').textContent = pct+'%';

    // footer pill
    const pill=$('#health-pill'), dot=$('#health-dot');
    if(pill && dot){
      pill.className='inline-flex items-center gap-2 px-3 py-1 rounded-full border '+
        (pct>=100?'bg-green-100 text-green-900 border-green-300':(pct<80?'bg-rose-100 text-rose-900 border-rose-300':'bg-amber-100 text-amber-900 border-amber-300'));
      dot.className='inline-block w-2 h-2 rounded-full '+(pct>=100?'bg-green-500':(pct<80?'bg-rose-500':'bg-amber-500'));
      $('#vo-health').textContent = pct>=100?'Ahead-of-Plan':(pct<80?'At-Risk':'On-Plan');
      $('#vo-footer-text').textContent = `Planned total is ${plannedTotal.toLocaleString()}. Week ${ws}–${we.toISOString().slice(0,10)}`;
    }
  }

  // ---------- setWeek ----------
  async function setWeek(ws){
    state.weekStart=ws; $('#week-start').value=ws; renderCapsules(ws);
    const end = new Date(ws); end.setDate(end.getDate()+6);
    const weISO = iso(end);
    const [plan, recs] = await Promise.all([fetchPlan(ws), fetchActuals(ws,weISO)]);
    state.plan = Array.isArray(plan)?plan:[]; state.records = Array.isArray(recs)?recs:[];
    setFooterTiles(ws,weISO,state.plan,state.records);
    await refreshDashboardTotals();
  }

  // ---------- Plan uploads / zero ----------
  $('#btn-upload-plan').onclick=()=>$('#file-plan').click();
  $('#file-plan').addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; e.target.value=''; if(!f||!apiBase) return;
    const text = await f.text();
    const lines = text.split(/\r?\n/).filter(Boolean);
    const hdr = lines.shift().split(',').map(s=>s.trim().toLowerCase().replace(/\s+/g,'_'));
    const idx=(n)=>hdr.indexOf(n);
    const iPO=idx('po_number')>=0?idx('po_number'):idx('po');
    const iSKU=idx('sku_code')>=0?idx('sku_code'):idx('sku');
    const iDue=idx('due_date')>=0?idx('due_date'):idx('due');
    const iQty=idx('target_qty')>=0?idx('target_qty'):idx('planned');
    if(iPO<0||iSKU<0||iDue<0){alert('CSV must include PO, SKU, Due Date');return;}
    const weekStart = $('#week-start').value;
    const rows = lines.map(l=>l.split(',')).map(r=>({po_number:r[iPO]?.trim(), sku_code:r[iSKU]?.trim(), start_date:weekStart, due_date:r[iDue]?.trim(), target_qty:Number((r[iQty]||'0').replace(/,/g,''))||0})).filter(r=>r.po_number&&r.sku_code&&r.due_date);
    await fetch(`${apiBase}/plan/weeks/${weekStart}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(rows)});
    alert(`Plan uploaded: ${rows.length} rows`);
    setWeek(weekStart);
  });
  $('#btn-zero-plan').onclick=async()=>{
    if(!apiBase) return alert('API not configured');
    const ws=$('#week-start').value;
    try{
      let r=await fetch(`${apiBase}/plan/weeks/${ws}/zero`,{method:'POST'});
      if(!r.ok&&r.status!==404){throw new Error(await r.text())}
      if(r.status===404){await fetch(`${apiBase}/plan/weeks/${ws}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:'[]'})}
      alert('Plan zeroed'); setWeek(ws);
    }catch(e){alert('Zero failed: '+(e.message||e))}
  };

  // ---------- Intake table ----------
  const intakeRows=[];
  function newRow(){return {id:crypto.randomUUID(), selected:false, date_local:iso(new Date()), mobile_bin:'', sscc_label:'', po_number:'', sku_code:'', uid:'', status:'draft', sync:'pending', _pending:{}};}
  function requiredFilled(r){return r.date_local && r.mobile_bin && r.po_number && r.sku_code && r.uid;}
  function syncClass(s){return s==='synced'?'bg-green-500':(s==='pending'?'bg-amber-500':'bg-gray-400');}
  function toIntakeRow(r){return {id:r.id, selected:false, date_local:r.date_local||iso(new Date()), mobile_bin:r.mobile_bin||'', sscc_label:r.sscc_label||'', po_number:r.po_number||'', sku_code:r.sku_code||'', uid:r.uid??'', status:r.status||'complete', sync:'synced', _pending:{}};}

  function renderIntake(){
    const tb=$('#intake-body'); tb.innerHTML='';
    if(!intakeRows.length) intakeRows.push(newRow());
    let drafts=0, synced=0;
    intakeRows.forEach((r,i)=>{
      const tr=document.createElement('tr'); tr.className=i%2?'bg-gray-50':'bg-white';
      if(r.status!=='complete') drafts++; else synced++;
      tr.innerHTML=`
        <td class="border px-2 py-2"><input type="checkbox" ${r.selected?'checked':''} data-id="${r.id}" data-role="sel"/></td>
        <td class="border px-2 py-2"><input class="cell" value="${r.date_local}" data-id="${r.id}" data-f="date_local"/></td>
        <td class="border px-2 py-2"><input class="cell" value="${r.mobile_bin}" data-id="${r.id}" data-f="mobile_bin"/></td>
        <td class="border px-2 py-2"><input class="cell" value="${r.sscc_label}" data-id="${r.id}" data-f="sscc_label" placeholder="(optional)"/></td>
        <td class="border px-2 py-2"><input class="cell" value="${r.po_number}" data-id="${r.id}" data-f="po_number"/></td>
        <td class="border px-2 py-2"><input class="cell" value="${r.sku_code}" data-id="${r.id}" data-f="sku_code"/></td>
        <td class="border px-2 py-2"><input class="cell" value="${r.uid}" data-id="${r.id}" data-f="uid" data-last="1"/></td>
        <td class="border px-2 py-2 text-center"><span class="dot ${syncClass(r.sync)}"></span></td>`;
      tb.appendChild(tr);
    });

    tb.querySelectorAll('input[data-role="sel"]').forEach(chk=>{
      chk.addEventListener('change',e=>{
        const id=e.target.dataset.id; const row=intakeRows.find(x=>x.id===id); if(row){row.selected=e.target.checked;}
        $('#chk-all').checked = intakeRows.length && intakeRows.every(r=>r.selected);
      });
    });

    tb.querySelectorAll('input[data-f]').forEach(inp=>{
      const id=inp.dataset.id, f=inp.dataset.f;
      if(f==='uid'){
        inp.addEventListener('keydown',(ev)=>{
          if(ev.key==='Tab' && !ev.shiftKey){
            const idx=intakeRows.findIndex(x=>x.id===id);
            if(idx===intakeRows.length-1){ setTimeout(()=>{ intakeRows.push(newRow()); renderIntake(); },0); }
          }
        });
      }
      inp.addEventListener('input',e=>{
        const row=intakeRows.find(x=>x.id===id); if(!row) return;
        row[f] = (f==='uid') ? String(e.target.value ?? '') : String(e.target.value||'').trim(); // UID verbatim
        row.status = requiredFilled(row) ? 'complete' : 'draft';
        row.sync = 'pending';
      });
      inp.addEventListener('change', async e=>{
        const row=intakeRows.find(x=>x.id===id); if(!row) return;
        if(!apiBase || !requiredFilled(row)){ renderIntake(); return; }
        try{
          const res=await fetch(`${apiBase}/records`,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
              id:row.id, date_local:row.date_local, mobile_bin:row.mobile_bin, sscc_label:row.sscc_label,
              po_number:row.po_number, sku_code:row.sku_code, uid:row.uid
            })
          });
          const j=await res.json().catch(()=>({}));
          if(res.ok && j.ok){ row.status='complete'; row.sync='synced'; }
          else { row.sync='pending'; }
        }catch{ row.sync='pending'; }
        renderIntake();
        await loadOpsMetrics(); await refreshDashboardTotals();
      });
    });

    // ribbon quick counts
    $('#ops-drafts').textContent = drafts;
    $('#ops-sync-badges').innerHTML =
      `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full border text-[11px] border-green-200 bg-green-50 text-green-700">synced: ${synced}</span>
       <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full border text-[11px] border-amber-200 bg-amber-50 text-amber-700">pending: ${drafts}</span>`;
  }

  // Add row / Delete selected
  $('#btn-add-row').onclick=()=>{intakeRows.push(newRow()); renderIntake();};
  $('#btn-delete-selected').onclick=async()=>{
    const selected=intakeRows.filter(r=>r.selected);
    if(!selected.length) return alert('Select at least one row.');
    if(!confirm(`Delete ${selected.length} row(s)?`)) return;

    if(apiBase){
      const pairs=selected.filter(r=>r.uid && r.sku_code).map(r=>({uid:r.uid, sku_code:r.sku_code}));
      if(pairs.length){
        try{ await fetch(`${apiBase}/records/delete`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(pairs)}); }catch(e){ console.warn('Server delete error',e); }
      }
    }
    for(let i=intakeRows.length-1;i>=0;i--){ if(intakeRows[i].selected) intakeRows.splice(i,1); }
    if(!intakeRows.length) intakeRows.push(newRow());
    renderIntake();
    await loadOpsMetrics(); await refreshDashboardTotals();
  };

  // Export
  $('#btn-export-day').onclick=()=>{ if(!apiBase) return; const d=iso(new Date()); window.location=`${apiBase}/export/xlsx?date=${d}`; };

  // Upload UIDs → table first → auto-save rows
  (function wireUploadUIDs(){
    const btn=$('#btn-upload-applied'), file=$('#file-upload-applied');
    btn.onclick=()=>file.click();
    file.addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; e.target.value=''; if(!f) return;
      try{
        let rows=[];
        if(/\.xlsx?$/i.test(f.name)){
          const buf=await f.arrayBuffer(); const wb=XLSX.read(buf,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
          rows=XLSX.utils.sheet_to_json(ws,{defval:''});
        }else{
          const text=await f.text(); const lines=text.split(/\r?\n/).filter(Boolean);
          const hdr=lines.shift().split(',').map(s=>s.trim()); rows=lines.map(l=>l.split(',')).map(c=>{const o={};hdr.forEach((h,i)=>o[h]=c[i]??'');return o;});
        }
        const normRow=(r)=>{const n={}; for(const k in r){n[k.toLowerCase().replace(/\s+/g,'_')]=r[k];}
          const pick=(...names)=>{for(const x of names){const v=n[x]; if(v!=null && String(v).trim()!=='') return String(v).trim();} return '';}
          const pickRaw=(...names)=>{for(const x of names){ if(x in n) return String(n[x]??''); } return '';};
          return {date_local:pick('date_local','date'), mobile_bin:pick('mobile_bin','mobile_bin_(box)','mobile_bin_box','mobile_bin (box)'),
                  sscc_label:pick('sscc_label','sscc_label_(box)','sscc','sscc_label (box)'), po_number:pick('po_number','po','po#'),
                  sku_code:pick('sku_code','sku'), uid:pickRaw('uid','u_id','u id')}; };
        const items = rows.map(normRow).filter(r=>r.po_number && r.sku_code && (r.uid!==''));
        if(!items.length) return alert('No valid rows found (need PO_Number, SKU_Code, UID).');

        for(const r of items){
          const ui=newRow();
          ui.date_local=r.date_local || iso(new Date());
          ui.mobile_bin=r.mobile_bin||'';
          ui.sscc_label=r.sscc_label||'';
          ui.po_number=r.po_number;
          ui.sku_code=r.sku_code;
          ui.uid=r.uid; // verbatim
          ui.status=requiredFilled(ui)?'complete':'draft';
          ui.sync='pending';
          intakeRows.push(ui);

          if(requiredFilled(ui) && apiBase){
            try{
              const res=await fetch(`${apiBase}/records`,{method:'POST',headers:{'Content-Type':'application/json'},
                body:JSON.stringify({id:ui.id,date_local:ui.date_local,mobile_bin:ui.mobile_bin,sscc_label:ui.sscc_label,po_number:ui.po_number,sku_code:ui.sku_code,uid:ui.uid})});
              const j=await res.json().catch(()=>({})); if(res.ok && j.ok){ui.sync='synced'; ui.status='complete';}
            }catch{}
          }
        }
        renderIntake();
        await loadOpsMetrics(); await refreshDashboardTotals();
      }catch(err){ console.error(err); alert('Upload failed: '+(err?.message||err)); }
    });
  })();

  // ---------- Ops metrics (use completed_at) ----------
  function todayISO(){const d=new Date(); d.setHours(0,0,0,0); return iso(d);}
  function isoMs(s){const d=new Date(s); return isNaN(d)?null:d.getTime();}
  async function loadOpsMetrics(){
    if(!apiBase) return;
    try{
      const res=await fetch(`${apiBase}/records?limit=5000`);
      if(!res.ok) throw new Error(await res.text());
      const rows=(await res.json()).records||[];
      const now=Date.now(), startToday=new Date(); startToday.setHours(0,0,0,0);
      const hourAgo=now-3600e3, halfAgo=now-1800e3;
      let scansToday=0,lastHour=0,rate=0,drafts=0,dupes=0; const syncCounts={}, seen=new Set();
      for(const r of rows){
        const ct=r.completed_at?new Date(r.completed_at).getTime():null;
        const todayByCompletion=!!ct && ct>=startToday.getTime();
        if(r.status==='complete'){
          if(todayByCompletion) scansToday++;
          if(ct && ct>=hourAgo) lastHour++;
          if(ct && ct>=halfAgo) rate++;
          if(r.sku_code && r.uid){const k=r.sku_code+'|'+r.uid; if(seen.has(k)) dupes++; else seen.add(k);}
        } else drafts++;
        const s=r.sync_state||'unknown'; syncCounts[s]=(syncCounts[s]||0)+1;
      }
      $('#ops-today').textContent=scansToday.toLocaleString();
      $('#ops-hour').textContent=lastHour.toLocaleString();
      $('#ops-rate').textContent=(rate*2).toLocaleString();
      $('#ops-drafts').textContent=drafts.toLocaleString();
      $('#ops-dupes').textContent=dupes.toLocaleString();
      $('#ops-last-updated').textContent=new Date().toLocaleTimeString();
      const bpm=Math.max(40,Math.min(160,rate*2));
      $('#intake-bpm').textContent=bpm;
      const small=$('#ops-heart-small'); if(small){small.innerHTML=''; small.appendChild(createHeart(18,BRAND,bpm));}
      const big=$('#ops-heart'); if(big){big.innerHTML=''; big.appendChild(createHeart(24,BRAND,bpm));}
      const wrap=$('#ops-sync-badges'); if(wrap){wrap.innerHTML=''; Object.entries(syncCounts).sort((a,b)=>b[1]-a[1]).forEach(([name,count])=>{
        const span=document.createElement('span');
        span.className='inline-flex items-center gap-1 px-2 py-0.5 rounded-full border text-[11px] '+(name==='synced'?'border-green-200 bg-green-50 text-green-700':(name==='pending'?'border-amber-200 bg-amber-50 text-amber-700':'border-gray-200 bg-gray-50 text-gray-700'));
        span.textContent=`${name}: ${count}`; wrap.appendChild(span);
      });}
      const alerts=[]; if(drafts>0) alerts.push(`There ${drafts===1?'is':'are'} ${drafts} draft${drafts===1?'':'s'} to complete.`); if(dupes>0) alerts.push(`${dupes} duplicate UID${dupes===1?'':'s'} detected today.`);
      $('#ops-alerts').innerHTML = alerts.length ? alerts.map(t=>`<li>${t}</li>`).join('') : '<li class="text-gray-400">No alerts.</li>';
    }catch(e){ console.warn('Ops ribbon metrics load failed:',e); }
  }

  function startSSE(){
    if(!apiBase) return;
    try{
      const ev=new EventSource(`${apiBase}/events/scan`);
      $('#ops-dot')?.classList.replace('bg-gray-300','bg-green-500');
      ev.onmessage=async()=>{ await loadOpsMetrics(); await refreshDashboardTotals(); };
      ev.onerror = ()=>{ try{ev.close();}catch{}; $('#ops-dot')?.classList.replace('bg-green-500','bg-amber-500'); setTimeout(startSSE,3000); };
    }catch{}
  }

  // ---------- simple search card ----------
  (function attachSearch(){
    const el=$('#search-input'); if(!el) return;
    let t=null; el.addEventListener('input',(e)=>{
      clearTimeout(t);
      t=setTimeout(()=>{
        const term=String(e.target.value||'').trim();
        const wrap=$('#search-results'); if(!term){wrap.classList.add('hidden'); wrap.innerHTML=''; return;}
        const plan=state.plan, agg=aggregate(state.records); const rows=[];
        const plannedPO=plan.filter(p=>String(p.po_number).trim()===term).reduce((s,p)=>s+Number(p.target_qty||0),0);
        let appliedPO=0; for(const [k,v] of agg.byPO.entries()){ if(k===term) appliedPO+=v; }
        if(plannedPO||appliedPO) rows.push({scope:'PO',planned:plannedPO,applied:appliedPO,pct:plannedPO>0?Math.round((appliedPO/plannedPO)*100):0});
        const plannedSKU=plan.filter(p=>String(p.sku_code).trim()===term).reduce((s,p)=>s+Number(p.target_qty||0),0);
        let appliedSKU=0; for(const [k,v] of agg.bySKU.entries()){ if(k===term) appliedSKU+=v; }
        if(plannedSKU||appliedSKU) rows.push({scope:'SKU',planned:plannedSKU,applied:appliedSKU,pct:plannedSKU>0?Math.round((appliedSKU/plannedSKU)*100):0});
        wrap.classList.remove('hidden');
        wrap.innerHTML = rows.length ? rows.map(r=>`<div class="bg-gray-50 rounded-xl p-3 border"><div class="text-xs text-gray-500">${r.scope}</div><div class="text-sm mt-1">Planned: ${fmtInt(r.planned)} · Applied: ${fmtInt(r.applied)} · ${r.pct}%</div></div>`).join('') : '<div class="text-xs text-gray-500">No matches in this week.</div>';
      },300);
    });
  })();

  // ---------- init ----------
  (function init(){
    const ws=iso(mondayOf()); $('#week-start').value=ws; setWeek(ws);
    // routing
    function show(hash){ $('#page-dashboard').classList.add('hidden'); $('#page-intake').classList.add('hidden'); (hash==='#intake'?$('#page-intake'):$('#page-dashboard')).classList.remove('hidden'); }
    window.addEventListener('hashchange',()=>show(location.hash||'#dashboard')); show(location.hash||'#dashboard');
    // intake
    renderIntake();
    // hearts / metrics
    $('#ops-heart').appendChild(createHeart(24,BRAND,40));
    $('#ops-heart-small').appendChild(createHeart(18,BRAND,40));
    loadOpsMetrics(); startSSE();
  })();
  </script>
</body>
</html>