<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <!-- ⬇️ Set to your Render API base (no trailing slash) -->
  <meta name="api-base" content="https://vasuida1.onrender.com"/>
  <title>VelOzity Pinpoint</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    body{background:#f8fafc;color:#111827}
    .vo-nav{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid #eee}
    .container{max-width:none;width:min(96vw,1920px);margin:0 auto;padding:16px 24px}
    .dot{width:.6rem;height:.6rem;border-radius:9999px;display:inline-block}
    .heartbeat{animation:heartbeat 1.2s ease-in-out infinite;transform-origin:center}
    @keyframes heartbeat{0%{transform:scale(1)}15%{transform:scale(1.18)}30%{transform:scale(1)}45%{transform:scale(1.12)}60%{transform:scale(1)}100%{transform:scale(1)}}
    .cell{width:100%;padding:.4rem .5rem;border:0;outline:none}
    .cell:focus{box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .th{font-size:.75rem;font-weight:600;color:#374151}
    /* Shorter week capsule */
    .wkcap{border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:.55rem .75rem;width:86px}
    .wkcap .m{font-size:10px}
    .wkcap .d{font-size:16px;font-weight:700;line-height:1.1}
    .wkcap .t{font-size:11px;margin-top:2px;color:#990033}
    .wkcap .bar{height:6px;border-radius:9999px;background:#e5e7eb;overflow:hidden;margin-top:4px}
    .wkcap .bar>div{height:6px;border-radius:9999px;background:#990033;width:0%}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Top Nav -->
  <header class="vo-nav">
    <div class="container py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-xl font-semibold">VelOzity Pinpoint</div>
        <div id="vo-today" class="text-gray-500 text-sm"></div>
      </div>
      <nav class="flex items-center gap-2">
        <a href="#dashboard" id="nav-dash"   class="px-3 py-2 rounded-lg text-sm font-medium border border-rose-700 text-rose-700">Operations</a>
        <a href="#intake"    id="nav-intake" class="px-3 py-2 rounded-lg text-sm font-medium border border-rose-700 text-rose-700/80">Intake</a>
      </nav>
    </div>
  </header>

  <main class="container py-4">
    <!-- ================= Operations ================= -->
    <section id="page-dashboard" class="hidden">
      <div class="flex items-center justify-between mb-2">
        <div class="text-2xl font-semibold">Operations</div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Week start</label>
          <input id="week-start" type="date" class="px-2 py-1 border rounded-md text-sm"/>
          <input id="file-plan" type="file" accept=".xlsx,.csv" class="hidden"/>
          <button id="btn-upload-plan" class="px-3 py-2 rounded-lg text-sm border">Upload Plan</button>
          <button id="btn-zero-plan"   class="px-3 py-2 rounded-lg text-sm border">Zero Plan</button>
        </div>
      </div>

      <!-- Capsules + Actions -->
      <div class="mb-3 flex items-center justify-between gap-3">
        <div id="capsules" class="hidden sm:flex items-center gap-3"></div>
        <div class="flex flex-wrap gap-2">
          <button id="btn-dl-posku" class="px-3 py-2 rounded-lg border text-sm">PO + SKU Discrepancy</button>
          <button id="btn-dl-po"    class="px-3 py-2 rounded-lg border text-sm">PO Discrepancy</button>
          <button id="btn-exec"     class="px-3 py-2 rounded-lg border text-sm bg-rose-700 text-white">Executive Summary</button>
        </div>
      </div>

      <!-- KPI tiles -->
      <div class="grid grid-cols-1 sm:grid-cols-5 gap-3 mb-3">
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold text-gray-600">Planned</div>
          <div class="text-xs text-gray-500" id="planned-range"></div>
          <div class="text-2xl font-bold tabular-nums" id="planned-total">0</div>
        </div>
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold text-gray-600">Applied</div>
          <div class="text-xs text-gray-500" id="applied-range"></div>
          <div class="text-2xl font-bold tabular-nums" id="applied-total">0</div>
        </div>
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold text-gray-600">Completion</div>
          <div class="text-xs text-gray-500">&nbsp;</div>
          <div class="text-2xl font-bold tabular-nums" id="pct-week">0%</div>
        </div>
        <div class="bg-white rounded-2xl border shadow p-4 flex items-center gap-4">
          <div id="ops-heart"></div>
          <div>
            <div class="text-base font-semibold text-gray-600">Ops Pulse</div>
            <div class="text-xl font-bold tabular-nums" id="ops-bpm">0</div>
            <div class="text-[11px] text-gray-500" id="ops-extra">+0 over 40</div>
          </div>
        </div>
        <div class="bg-white rounded-2xl border shadow p-4">
          <div class="text-base font-semibold text-gray-600">Applied averages</div>
          <div class="text-xs text-gray-500 mb-1">&nbsp;</div>
          <div class="text-2xl font-bold tabular-nums" id="avg-day">0</div>
          <div class="text-xs text-gray-500 mt-1">Avg/day • <span id="avg-week">0</span></div>
        </div>
      </div>

      <!-- Search -->
      <div class="bg-white rounded-2xl border shadow p-4 mb-3">
        <div class="text-base font-semibold mb-2">Search by PO or SKU</div>
        <input id="search-input" type="search" placeholder="Type a PO # or SKU Code and pause…" class="w-full border rounded-md px-3 py-2 text-sm outline-none focus:ring-2">
        <div id="search-results" class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3 hidden"></div>
      </div>

<!-- Top Insights -->
<div class="bg-white rounded-2xl border shadow p-4 mb-3">
  <div class="text-base font-semibold mb-2">Top Insights for Ops</div>
  <ul id="insights" class="text-sm text-gray-800 list-disc pl-5 space-y-1">
    <li>Loading…</li>
  </ul>
  <div id="insights-mini" class="mt-2 text-xs text-gray-500"></div>
</div>

<!-- PO Progress (This Week) -->
<div class="bg-white rounded-2xl border shadow p-4 mb-3">
  <div class="text-base font-semibold mb-2">PO Progress (This Week)</div>
  <div class="overflow-auto max-h-[480px]">
    <table class="w-full text-sm" id="po-progress">
      <thead>
        <tr class="text-gray-500">
          <th class="text-left py-1 pr-2">PO #</th>
          <th class="text-left py-1 pr-2">Due</th>
          <th class="text-right py-1 pr-2">Planned</th>
          <th class="text-right py-1 pr-2">Applied</th>
          <th class="text-right py-1">%</th>
        </tr>
      </thead>
      <tbody id="po-progress-body">
        <tr><td colspan="5" class="text-center text-xs text-gray-400 py-3">Loading…</td></tr>
      </tbody>
    </table>
  </div>
</div>

      <!-- Risks -->
<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
  <!-- Top PO's at Risk -->
  <div class="bg-white rounded-2xl border shadow p-4">
    <div class="text-base font-semibold mb-2">Top PO's at Risk</div>
    <table class="w-full text-sm">
      <thead>
        <tr class="text-gray-500">
          <th class="text-left py-1 pr-2">PO #</th>
          <th class="text-left py-1 pr-2">Due</th>
          <th class="text-right py-1 pr-2">Planned</th>
          <th class="text-right py-1 pr-2">Applied</th>
          <th class="text-right py-1 pr-2">Rem</th>
          <th class="text-right py-1">%</th>
        </tr>
      </thead>
      <tbody id="risk-po-body">
        <tr><td colspan="6" class="text-center text-xs text-gray-400 py-3">Loading…</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Top SKU's at Risk -->
  <div class="bg-white rounded-2xl border shadow p-4">
    <div class="text-base font-semibold mb-2">Top SKU's at Risk</div>
    <table class="w-full text-sm">
      <thead>
        <tr class="text-gray-500">
          <th class="text-left py-1 pr-2">SKU</th>
          <th class="text-left py-1 pr-2">Due</th>
          <th class="text-right py-1 pr-2">Planned</th>
          <th class="text-right py-1 pr-2">Applied</th>
          <th class="text-right py-1 pr-2">Rem</th>
          <th class="text-right py-1">%</th>
        </tr>
      </thead>
      <tbody id="risk-sku-body">
        <tr><td colspan="6" class="text-center text-xs text-gray-400 py-3">Loading…</td></tr>
      </tbody>
    </table>
  </div>
</div>
    </section>

    <!-- ================= UID Intake ================= -->
    <section id="page-intake" class="hidden">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-5">
          <div class="text-2xl font-semibold">UID Intake (Table Mode)</div>
          <div class="flex items-center gap-2 bg-white border rounded-xl px-3 py-2">
            <svg viewBox="0 0 24 24" width="18" height="18" class="heartbeat">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" fill="#990033"/>
            </svg>
            <div class="text-sm"><span class="font-semibold">Ops</span> • <span id="intake-bpm">0</span> bpm</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btn-export-day" class="px-3 py-2 rounded-lg text-sm border">Export XLSX</button>
          <button id="btn-upload-applied" class="px-3 py-2 rounded-lg text-sm border">Upload UIDs</button>
          <input id="file-upload-applied" type="file" accept=".xlsx,.csv" class="hidden"/>
          <button id="btn-delete-selected" class="px-3 py-2 rounded-lg text-sm border border-rose-700 text-rose-700">Delete Selected</button>
        </div>
      </div>

      <!-- Ops ribbon -->
      <div id="ops-ribbon" class="mt-3 bg-white border rounded-xl shadow p-3">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-stretch">
          <div class="flex gap-3">
            <div class="flex-1 border rounded-lg p-3">
              <div class="text-xs text-gray-500">Scans Today</div>
              <div id="ops-today" class="text-2xl font-bold tabular-nums">0</div>
            </div>
            <div class="flex-1 border rounded-lg p-3">
              <div class="text-xs text-gray-500">Last Hour</div>
              <div id="ops-hour" class="text-2xl font-bold tabular-nums">0</div>
            </div>
          </div>
          <div class="flex items-center gap-4 border rounded-lg p-3">
            <div id="ops-heart-small"></div>
            <div>
              <div class="text-xs text-gray-500">Throughput / hr (last 30m)</div>
              <div id="ops-rate" class="text-2xl font-bold tabular-nums">0</div>
            </div>
          </div>
          <div class="border rounded-lg p-3">
            <div class="text-sm font-semibold mb-1">Data Quality</div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-500">Drafts</span><strong id="ops-drafts">0</strong>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-500">Duplicates</span><strong id="ops-dupes">0</strong>
            </div>
            <div class="text-xs text-gray-500 mt-2">Sync states</div>
            <div id="ops-sync-badges" class="flex flex-wrap gap-2 mt-1"></div>
          </div>
          <div class="border rounded-lg p-3">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">Alerts</div>
              <small class="text-gray-500">
                <span id="ops-last-updated">—</span>
                <span class="inline-flex items-center gap-1 border rounded-full px-2 py-0.5 text-[11px] text-gray-500">
                  <span id="ops-dot" class="w-2 h-2 rounded-full bg-gray-300"></span>SSE
                </span>
              </small>
            </div>
            <ul id="ops-alerts" class="list-disc ml-4 mt-1 text-sm"><li class="text-gray-400">No alerts.</li></ul>
          </div>
        </div>
      </div>

      <!-- Intake Table -->
      <div class="mt-3 overflow-auto">
        <table class="w-full min-w-[1100px] border-collapse border">
          <thead class="bg-gray-100">
          <tr>
            <th class="th border px-2 py-1 text-left w-8"><input type="checkbox" id="chk-all"/></th>
            <th class="th border px-2 py-1 text-left">Date</th>
            <th class="th border px-2 py-1 text-left">Mobile Bin (BOX)</th>
            <th class="th border px-2 py-1 text-left">SSCC Label (BOX)</th>
            <th class="th border px-2 py-1 text-left">PO_Number</th>
            <th class="th border px-2 py-1 text-left">SKU_Code</th>
            <th class="th border px-2 py-1 text-left">UID</th>
            <th class="th border px-2 py-1 text-center">Sync</th>
          </tr>
          </thead>
          <tbody id="intake-body"></tbody>
        </table>
      </div>

      <div class="mt-3">
        <button id="btn-add-row" class="px-3 py-2 rounded-lg border text-sm">Add Row</button>
      </div>
    </section>
  </main>

  <!-- Footer health pill (shows Applied this week) -->
  <div id="vo-footer" style="position:fixed;left:0;right:0;bottom:0;z-index:50;font-size:12px;background:transparent;padding:.5rem .75rem;display:flex;gap:.75rem;align-items:center;">
    <span id="health-pill" class="inline-flex items-center gap-2 px-3 py-1 rounded-full border bg-amber-100 text-amber-900 border-amber-300">
      <span id="health-dot" class="inline-block w-2 h-2 rounded-full bg-amber-500"></span>
      Health: <span id="vo-health" class="ml-1">n/a</span>
    </span>
    <span id="vo-footer-text">Applied this week: 0</span>
  </div>

  <script>
  const BRAND = '#990033';
const BASE_BPM = 40;
  const apiBase = (document.querySelector('meta[name="api-base"]')?.content || '').replace(/\/+$/,'');
  const $ = (s)=>document.querySelector(s);
  $('#vo-today').textContent = new Date().toLocaleDateString();
const iso = (d) => d.toISOString().slice(0,10);
const mondayOf = (d=new Date()) => { const x=new Date(d); const day=x.getDay(); const diff=(day===0?-6:1)-day; x.setDate(x.getDate()+diff); x.setHours(0,0,0,0); return x; };
const fmtInt = (n) => Number(n||0).toLocaleString();
const toNum = (v) => Number(String(v ?? 0).toString().replace(/,/g, '')) || 0;
const toUI = (isoStr) =>
  (isoStr && typeof isoStr === 'string' && isoStr.includes('-'))
    ? isoStr.split('-').reverse().join('-')
    : (isoStr || '');

function createHeart(size=24, color=BRAND, bpm=40){
  const s='http://www.w3.org/2000/svg', svg=document.createElementNS(s,'svg');
  svg.setAttribute('viewBox','0 0 24 24'); svg.setAttribute('width',size); svg.setAttribute('height',size);
  const p=document.createElementNS(s,'path');
  p.setAttribute('d','M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z');
  p.setAttribute('fill', color); svg.appendChild(p);
  svg.classList.add('heartbeat'); svg.style.animationDuration = `${(60/Math.max(40,bpm)).toFixed(2)}s`;
  return svg;
}
  // API helpers
  const state={weekStart:iso(mondayOf()), plan:[], records:[]};
  async function api(path,opts={}){const r=await fetch(`${apiBase}${path}`,{method:opts.method||'GET',headers:{'Content-Type':'application/json'},body:opts.body?JSON.stringify(opts.body):undefined}); if(!r.ok) throw new Error(await r.text()); const ct=r.headers.get('content-type')||''; return ct.includes('json')?r.json():r.text();}
  async function fetchPlan(w){
  if(!apiBase) return [];
  try {
    return await api(`/plan/weeks/${w}?limit=50000`);
  } catch {
    return [];
  }
}

async function fetchActualsAll(){
  if (!apiBase) return [];
  try {
    const d = await api(`/records?limit=50000`);
    return d.records || [];
  } catch {
    return [];
  }
}
  async function fetchActuals(f,t){ if(!apiBase) return []; try{const d=await api(`/records?from=${f}&to=${t}&status=complete&limit=50000`); return d.records||[];}catch{return [];} }

  // ---------- Capsules ----------
  function addDaysISO(s,days){const [y,m,d]=s.split('-').map(Number);const b=new Date(y,m-1,d);b.setDate(b.getDate()+days);return iso(b)}
  function renderCapsules(baseISO, plannedTotal=0, appliedTotal=0){
    const r=$('#capsules'); if(!r) return; r.classList.remove('hidden'); r.innerHTML='';
    const list=[-7,0,7,14,21].map(n=>addDaysISO(baseISO,n));
    list.forEach(id=>{
      const d=new Date(id+'T00:00:00');
      const day=String(d.getDate()).padStart(2,'0');
      const mon=d.toLocaleString('en-US',{month:'short'}).toUpperCase().slice(0,3);
      const el=document.createElement('button'); el.className='wkcap bg-white hover:scale-[1.02] transition';
      el.style.borderColor=(id===state.weekStart?BRAND:'rgba(0,0,0,.12)');
      el.innerHTML=`<div class="m" style="color:${id===state.weekStart?BRAND:'#6b7280'}">${mon}</div>
                    <div class="d">${day}</div>
                    <div class="t" id="cap-total-${id}">${fmtInt(id===state.weekStart?plannedTotal:0)}</div>
                    <div class="bar"><div id="cap-bar-${id}"></div></div>`;
      el.onclick=()=>{ $('#week-start').value=id; setWeek(id); };
      r.appendChild(el);
      const p = plannedTotal>0 && id===state.weekStart ? Math.min(100, Math.round(appliedTotal*100/plannedTotal)) : 0;
      const bar = el.querySelector(`#cap-bar-${id}`); if(bar) bar.style.width = `${p}%`;
    });
  }

  // ---------- Aggregations ----------
  function aggregate(records){const byPO=new Map(),bySKU=new Map(); for(const r of records){ if(r.status!=='complete') continue; const po=String(r.po_number||'').trim(), sku=String(r.sku_code||'').trim(); if(po) byPO.set(po,(byPO.get(po)||0)+1); if(sku) bySKU.set(sku,(bySKU.get(sku)||0)+1);} return {byPO,bySKU};}
  function joinPOProgress(plan, byPO){
    const map=new Map();
    for(const p of plan||[]){ const po=String(p.po_number||'').trim(); if(!po) continue; const rec=map.get(po)||{due:p.due_date,planned:0,applied:0}; rec.planned+=toNum(p.target_qty); if(rec.due!==p.due_date) rec.due = rec.due < p.due_date ? rec.due : p.due_date; map.set(po,rec); }
    for(const [po,ap] of byPO.entries()){ const rec=map.get(po)||{due:'',planned:0,applied:0}; rec.applied+=ap; map.set(po,rec);}
    const list=[]; for(const [po,rec] of map.entries()){ list.push({po,due:rec.due,planned:rec.planned,applied:rec.applied,pct:rec.planned>0?Math.round(rec.applied*100/rec.planned):100}); }
    list.sort((a,b)=>String(a.due).localeCompare(String(b.due))); return list;
  }

  // ---------- Dashboard render ----------
  function computeRisk(rows){
  // Show top items with remaining > 0, regardless of week end
  const out = [];
  for (const r of rows || []) {
    const planned = Number(r.planned || 0);
    const applied = Number(r.applied || 0);
    const remaining = Math.max(0, planned - applied);
    if (remaining > 0) {
      out.push({
        key: r.po || r.sku || r.key,
        due_date: r.due || r.due_date || '',
        planned,
        applied,
        remaining,
        pct: planned > 0 ? Math.round((applied / planned) * 100) : 0,
      });
    }
  }
  // Prioritize by remaining qty, then earliest due date if available
  out.sort((a, b) => b.remaining - a.remaining ||
                     (new Date(a.due_date || '9999-12-31')) -
                     (new Date(b.due_date || '9999-12-31')));
  return out.slice(0, 5);
}
  
  function setFooterHealth(pct, appliedWeek){
    const pill=$('#health-pill'), dot=$('#health-dot');
    let cls='bg-amber-100 text-amber-900 border-amber-300', d='bg-amber-500', label='On-Plan';
    if(pct>=100){cls='bg-green-100 text-green-900 border-green-300'; d='bg-green-500'; label='Ahead-of-Plan';}
    else if(pct<80){cls='bg-rose-100 text-rose-900 border-rose-300'; d='bg-rose-500'; label='At-Risk';}
    pill.className='inline-flex items-center gap-2 px-3 py-1 rounded-full border '+cls;
    dot.className='inline-block w-2 h-2 rounded-full '+d;
    $('#vo-health').textContent=label;
    $('#vo-footer-text').textContent=`Applied this week: ${fmtInt(appliedWeek)}`;
  }

  // ---------- Downloads ----------
  function toCSV(header,rows){
    const esc=v=>{v=String(v??''); return /[",\n]/.test(v)?('"'+v.replace(/"/g,'""')+'"'):v;}
    const head=header.map(esc).join(','), body=rows.map(r=>header.map(h=>esc(r[h])).join(',')).join('\r\n');
    return '\ufeff'+head+'\r\n'+body+'\r\n';
  }
  function buildDiscrepancyPOSKU(plan, records){
    const byPS=new Map();
    for(const r of records||[]){ if(r.status!=='complete') continue; const po=String(r.po_number||'').trim(), sku=String(r.sku_code||'').trim(); if(!po||!sku) continue; const k=`${po}|||${sku}`; byPS.set(k,(byPS.get(k)||0)+1); }
    const seen=new Set(); const rows=[];
    for(const p of plan||[]){ const po=String(p.po_number||'').trim(), sku=String(p.sku_code||'').trim(); if(!po||!sku) continue; const k=`${po}|||${sku}`; if(seen.has(k)) continue; seen.add(k);
      const planned=toNum(p.target_qty), applied=byPS.get(k)||0;
      rows.push({'PO':po,'SKU':sku,'Planned':planned,'Applied':applied,'Discrepancy (Applied - Planned)':applied-planned});
    }
    return rows;
  }
  function buildDiscrepancyPO(joined){
    return (joined||[]).map(r=>({'PO':r.po,'Planned':r.planned||0,'Applied':r.applied||0,'Discrepancy (Applied - Planned)':(r.applied||0)-(r.planned||0)}));
  }
  function buildExecHTML({
  ws, we,
  plannedTotal, appliedTotal, pct,
  uniqueBins,
  topPOSKU,             // [{po, sku, planned, applied, pct}]
  topBins,              // [{bin, units, uniqueSkus}]
  insights              // [string, ...]
}) {
  const pretty = s => (s||'').split('-').reverse().join('-');

  const rowsPOSKU = (topPOSKU||[])
    .map(r=>`<tr>
      <td>${r.po}</td>
      <td>${r.sku}</td>
      <td style="text-align:right">${(r.planned||0).toLocaleString()}</td>
      <td style="text-align:right">${(r.applied||0).toLocaleString()}</td>
      <td style="text-align:right">${r.pct}%</td>
    </tr>`).join('');

  const rowsBins = (topBins||[])
    .map(r=>`<tr>
      <td>${r.bin}</td>
      <td style="text-align:right">${(r.units||0).toLocaleString()}</td>
      <td style="text-align:right">${(r.uniqueSkus||0).toLocaleString()}</td>
    </tr>`).join('');

  const bullets = (insights||[])
    .map(t=>`<li>${t}</li>`).join('');

  return `<!doctype html><meta charset="utf-8">
  <div style="font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111;line-height:1.35">
    <h1 style="margin:0 0 8px;font-size:22px;color:${BRAND}">VAS Weekly Executive Summary</h1>
    <div style="color:#555;font-size:12px;margin-bottom:16px">Week: ${pretty(ws)} – ${pretty(we)}</div>

    <!-- KPIs -->
    <table style="width:100%;border-collapse:collapse;margin-bottom:16px">
      <tr>
        <td style="padding:10px;border:1px solid #eee">
          <div style="font-size:12px;color:#666;margin-bottom:4px">Planned</div>
          <div style="font-size:20px;font-weight:700">${plannedTotal.toLocaleString()}</div>
        </td>
        <td style="padding:10px;border:1px solid #eee">
          <div style="font-size:12px;color:#666;margin-bottom:4px">Applied</div>
          <div style="font-size:20px;font-weight:700">${appliedTotal.toLocaleString()}</div>
        </td>
        <td style="padding:10px;border:1px solid #eee">
          <div style="font-size:12px;color:#666;margin-bottom:4px">Completion</div>
          <div style="font-size:20px;font-weight:700">${pct}%</div>
        </td>
        <td style="padding:10px;border:1px solid #eee">
          <div style="font-size:12px;color:#666;margin-bottom:4px">Mobile Bins (wk)</div>
          <div style="font-size:20px;font-weight:700">${uniqueBins.toLocaleString()}</div>
        </td>
      </tr>
    </table>

    <!-- Insights -->
    <h2 style="font-size:16px;margin:0 0 8px">Top Insights</h2>
    <ul style="margin:0 0 16px 16px;padding:0">${bullets || '<li style="color:#888">No notable insights.</li>'}</ul>

    <!-- PO × SKU Applied -->
    <h2 style="font-size:16px;margin:0 0 8px">PO × SKU — Applied (Top)</h2>
    <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:16px">
      <thead>
        <tr>
          <th style="text-align:left;border-bottom:1px solid #eee;padding:6px 4px">PO #</th>
          <th style="text-align:left;border-bottom:1px solid #eee;padding:6px 4px">SKU</th>
          <th style="text-align:right;border-bottom:1px solid #eee;padding:6px 4px">Planned</th>
          <th style="text-align:right;border-bottom:1px solid #eee;padding:6px 4px">Applied</th>
          <th style="text-align:right;border-bottom:1px solid #eee;padding:6px 4px">%</th>
        </tr>
      </thead>
      <tbody>${rowsPOSKU || `<tr><td colspan="5" style="color:#888;padding:10px 4px">No PO × SKU rows found.</td></tr>`}</tbody>
    </table>

    <!-- Units by Mobile Bin -->
    <h2 style="font-size:16px;margin:0 0 8px">Units by Mobile Bin (Top)</h2>
    <table style="width:100%;border-collapse:collapse;font-size:13px">
      <thead>
        <tr>
          <th style="text-align:left;border-bottom:1px solid #eee;padding:6px 4px">Mobile Bin</th>
          <th style="text-align:right;border-bottom:1px solid #eee;padding:6px 4px">Units</th>
          <th style="text-align:right;border-bottom:1px solid #eee;padding:6px 4px">Unique SKUs</th>
        </tr>
      </thead>
      <tbody>${rowsBins || `<tr><td colspan="3" style="color:#888;padding:10px 4px">No bin data found.</td></tr>`}</tbody>
    </table>
  </div>`;
}

// ----- PO Progress table -----
function renderPOProgress(rows){
  const tbody = document.getElementById('po-progress-body');
  if (!tbody) return;
  tbody.innerHTML = '';

  if (!rows || !rows.length){
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-xs text-gray-400 py-3">No data</td></tr>';
    return;
  }

  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.className = 'odd:bg-gray-50';
    tr.innerHTML = `
      <td class="py-1 pr-2">${r.po}</td>
      <td class="py-1 pr-2">${r.due ? toUI(r.due) : ''}</td>
      <td class="py-1 pr-2 text-right tabular-nums">${(r.planned||0).toLocaleString()}</td>
      <td class="py-1 pr-2 text-right tabular-nums">${(r.applied||0).toLocaleString()}</td>
      <td class="py-1 text-right tabular-nums">${r.pct||0}%</td>
    `;
    tbody.appendChild(tr);
  });
}

// ----- Risk tables (PO / SKU) -----
function renderRisk(list, selector){
  const tbody = document.querySelector(selector);
  if (!tbody) return;
  tbody.innerHTML = '';

  if (!list || !list.length){
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-xs text-gray-400 py-3">No items at risk this week.</td></tr>';
    return;
  }

  list.forEach(r => {
    const tr = document.createElement('tr');
    tr.className = 'odd:bg-gray-50';
    tr.innerHTML = `
      <td class="py-1 pr-2 truncate" title="${r.key||r.po||''}">${r.key||r.po||''}</td>
      <td class="py-1 pr-2">${r.due_date ? toUI(r.due_date) : ''}</td>
      <td class="py-1 pr-2 text-right tabular-nums">${(r.planned||0).toLocaleString()}</td>
      <td class="py-1 pr-2 text-right tabular-nums">${(r.applied||0).toLocaleString()}</td>
      <td class="py-1 pr-2 text-right tabular-nums">${(r.remaining||0).toLocaleString()}</td>
      <td class="py-1 text-right tabular-nums">${r.pct||0}%</td>
    `;
    tbody.appendChild(tr);
  });
}

// ---------- Actionable Top Insights (with Duplicates & Bin diversity) ----------
function renderInsights(records, plan = [], weekStartISO = '') {
  const ul   = document.getElementById('insights');
  const mini = document.getElementById('insights-mini');
  if (!ul) return;

  // --- dates & helpers ---
  const today = todayISO();
  const ws    = weekStartISO || (typeof mondayOf === 'function' ? iso(mondayOf(new Date())) : today);
  const wsDate = new Date(ws + 'T00:00:00');
  const weDate = new Date(ws + 'T00:00:00'); weDate.setDate(weDate.getDate() + 6);
  const we = iso(weDate);
  const dayDiff = (a,b)=> Math.round((new Date(a+'T00:00:00') - new Date(b+'T00:00:00'))/86400000);
  const clamp01 = n => (n < 1 ? 1 : n);

  // --- applied aggregates (this week window only) ---
  const inWeek = (r) => {
  if (r.status !== 'complete') return false;
  const dl = toISODate(r.date_local);   // normalize to YYYY-MM-DD
  return dl && dl >= ws && dl <= we;
};
  const weekRecords = (records || []).filter(inWeek);

  // per-PO & per-SKU counts in week
  const appliedPO  = new Map();
  const appliedSKU = new Map();
  for (const r of weekRecords) {
    const po  = String(r.po_number||'').trim();
    const sku = String(r.sku_code||'').trim();
    if (po)  appliedPO.set(po,  (appliedPO.get(po)||0)  + 1);
    if (sku) appliedSKU.set(sku, (appliedSKU.get(sku)||0) + 1);
  }

  // --- plan aggregates (planned totals & earliest due) ---
  const planPO = new Map();   // po -> { planned, due }
  const planSKU = new Map();  // sku -> { planned, due }
  let plannedTotal = 0;

  for (const p of plan || []) {
    const po  = String(p.po_number||'').trim();
    const sku = String(p.sku_code||'').trim();
    const due = String(p.due_date||'').trim();
    const qty = toNum(p.target_qty);
    plannedTotal += qty;

    if (po) {
      const cur = planPO.get(po) || { planned:0, due: due || '' };
      cur.planned += qty;
      if (!cur.due || (due && new Date(due) < new Date(cur.due))) cur.due = due;
      planPO.set(po, cur);
    }
    if (sku) {
      const cur = planSKU.get(sku) || { planned:0, due: due || '' };
      cur.planned += qty;
      if (!cur.due || (due && new Date(due) < new Date(cur.due))) cur.due = due;
      planSKU.set(sku, cur);
    }
  }

  // --- priority lists (highest remaining, earliest due first) ---
  function buildPriority(listMap, appliedMap, keyName) {
    const rows = [];
    for (const [key, v] of listMap.entries()) {
      const planned = v.planned || 0;
      const applied = appliedMap.get(key) || 0;
      const remaining = Math.max(0, planned - applied);
      rows.push({ [keyName]: key, planned, applied, remaining, due: v.due || '' });
    }
    rows.sort((a, b) =>
      (b.remaining - a.remaining) || (new Date(a.due||'9999-12-31') - new Date(b.due||'9999-12-31'))
    );
    return rows;
  }
  const priorityPO  = buildPriority(planPO, appliedPO, 'po');
  const prioritySKU = buildPriority(planSKU, appliedSKU, 'sku');


// --- Mobile bins: unique (this week) + top 5 by SKU diversity (this week) ---
const binsWeek = new Set(
  (weekRecords || [])
    .map(r => String(r.mobile_bin || '').trim())
    .filter(Boolean)
);

// diversity across the week: bin -> set(sku)
const binSkuSet = new Map();
for (const r of weekRecords) {
  const bin = String(r.mobile_bin || '').trim();
  const sku = String(r.sku_code  || '').trim();
  if (!bin || !sku) continue;
  if (!binSkuSet.has(bin)) binSkuSet.set(bin, new Set());
  binSkuSet.get(bin).add(sku);
}

const binsByDiversity = Array.from(binSkuSet.entries())
  .map(([bin, set]) => ({ bin, uniqueSkus: set.size }))
  .sort((a,b) => b.uniqueSkus - a.uniqueSkus)
  .slice(0, 5);

  // --- Duplicate UID detection (this week) ---
  // “Duplicate” is defined as the same (SKU, UID) appearing more than once
  const pairCounts = new Map();
  for (const r of weekRecords) {
    const sku = String(r.sku_code||'').trim();
    const uid = String(r.uid||'').trim();
    if (!sku || !uid) continue;
    const k = `${sku}||${uid}`;
    pairCounts.set(k, (pairCounts.get(k)||0) + 1);
  }
  let dupScanCount = 0;
  const dupPairs = [];
  for (const [k, c] of pairCounts.entries()) {
    if (c > 1) {
      const [sku, uid] = k.split('||');
      dupPairs.push({ sku, uid, count: c });
      dupScanCount += c;
    }
  }
  dupPairs.sort((a,b)=> b.count - a.count);
  const dupExamples = dupPairs.slice(0,3).map(x => `${x.sku}×${x.uid}${x.count>2?`×${x.count}`:''}`);

  // --- Pace calculations (week + due-in-3-days horizon) ---
  const daysElapsed       = clamp01(7 - clamp01(dayDiff(ws, today) * -1));
  const appliedSoFar      = weekRecords.length;
  const avgPerDaySoFar    = Math.round(appliedSoFar / daysElapsed);
  const daysLeftInWeek    = clamp01(dayDiff(we, today) + 1);
  const remainingWeek     = Math.max(0, plannedTotal - appliedSoFar);
  const needPerDayWeek    = Math.ceil(remainingWeek / daysLeftInWeek);

  const due3Date = new Date(today + 'T00:00:00'); due3Date.setDate(due3Date.getDate() + 2);
  const due3ISO  = iso(due3Date);
  function sumPlannedDueBy(map) {
    let sum = 0;
    for (const v of map.values()) {
      if (!v.due) continue;
      if (v.due >= today && v.due <= due3ISO) sum += v.planned || 0;
    }
    return sum;
  }
  const plannedDue3 = sumPlannedDueBy(planPO);
  let appliedAgainstDue3 = 0;
  for (const [po, v] of planPO.entries()) {
    if (v.due && v.due >= today && v.due <= due3ISO) {
      appliedAgainstDue3 += appliedPO.get(po) || 0;
    }
  }
  const remainingDue3   = Math.max(0, plannedDue3 - appliedAgainstDue3);
  const daysLeftForDue3 = clamp01(Math.min(3, dayDiff(due3ISO, today) + 1));
  const needPerDayDue3  = remainingDue3 ? Math.ceil(remainingDue3 / daysLeftForDue3) : 0;

  // --- Build insight bullets (max 5) ---
  const bullets = [];

  // 1–2) Priority POs/SKUs to start
  if (priorityPO.length && priorityPO[0].remaining > 0) {
    const p = priorityPO[0];
    bullets.push(`Start with PO ${p.po} (remaining ${p.remaining.toLocaleString()} • due ${p.due ? toUI(p.due) : 'n/a'})`);
  }
  if (prioritySKU.length && prioritySKU[0].remaining > 0) {
    const s = prioritySKU[0];
    bullets.push(`Focus SKU ${s.sku} (remaining ${s.remaining.toLocaleString()} • due ${s.due ? toUI(s.due) : 'n/a'})`);
  }

  // 3) Mobile bins: total unique (this week) + top 5 by SKU diversity (this week)
if (binsByDiversity.length) {
  const tops = binsByDiversity.map(b => `${b.bin} (${b.uniqueSkus})`).join(', ');
  bullets.push(`Mobile bins (wk): ${binsWeek.size.toLocaleString()} • Top bins by SKU diversity (wk): ${tops}`);
} else {
  bullets.push(`Mobile bins (wk): ${binsWeek.size.toLocaleString()}`);
}

  // 4) Duplicate UID alert, if any
  if (dupPairs.length) {
    bullets.push(
      `Duplicate UIDs detected: ${dupScanCount.toLocaleString()} scans across ${dupPairs.length} pairs ` +
      `${dupExamples.length ? `(e.g., ${dupExamples.join(', ')})` : ''}`
    );
  } else {
    bullets.push(`No duplicate UIDs detected this week.`);
  }

  // 5) Weekly pace vs target (and 3-day horizon if relevant)
  const weekPace = `Weekly plan pace: need ~${needPerDayWeek.toLocaleString()}/day (current ${avgPerDaySoFar.toLocaleString()}/day)`;
  if (remainingDue3 > 0) {
    bullets.push(
      `${weekPace} • Due≤3d: target ~${needPerDayDue3.toLocaleString()}/day (rem ${remainingDue3.toLocaleString()})`
    );
  } else {
    bullets.push(weekPace);
  }

  // Render
  ul.innerHTML = bullets.slice(0, 5).map(t => `<li>${t}</li>`).join('');
  if (mini) mini.textContent = `Applied so far: ${appliedSoFar.toLocaleString()} • Remaining: ${remainingWeek.toLocaleString()}`;
}

async function fetchActuals(ws, we) {
  if (!apiBase) return [];
  try {
    // get everything, we’ll filter locally
    const d = await api(`/records?limit=50000`);
    const all = d.records || [];

    const startTs = new Date(ws + 'T00:00:00Z').getTime();
    const endTs   = startTs + 7 * 86400000;

    return all.filter(r => {
      if (r.status !== 'complete') return false;
      // Prefer the business date
      if (r.date_local && r.date_local >= ws && r.date_local <= we) return true;
      // Fallback to completion timestamp if date_local missing
      if (r.completed_at) {
        const t = new Date(r.completed_at).getTime();
        return t >= startTs && t < endTs;
      }
      return false;
    });
  } catch {
    return [];
  }
}

function weekEndISO(ws){ const d=new Date(ws); d.setDate(d.getDate()+6); return iso(d); }

function inWeekByDateLocal(r, ws){
  if (!r || r.status !== 'complete') return false;
  const we = weekEndISO(ws);                  // YYYY-MM-DD
  const dl = String(r.date_local || '').trim();
  return !!dl && dl >= ws && dl <= we;        // pure string compare on YYYY-MM-DD
}

function inWeekByCompletedAt(r, ws){
  if (!r || r.status !== 'complete' || !r.completed_at) return false;
  const start = new Date(ws + 'T00:00:00Z');
  const end   = new Date(start); end.setDate(end.getDate() + 7); // [start, end)
  const t = new Date(r.completed_at).getTime();
  return t >= start.getTime() && t < end.getTime();
}

  // ---------- setWeek ----------
  async function setWeek(ws){
    state.weekStart=ws; $('#week-start').value=ws;
    const weDate=new Date(ws); weDate.setDate(weDate.getDate()+6); const we=iso(weDate);
const [plan, allRecs] = await Promise.all([fetchPlan(ws), fetchActualsAll()]);
state.plan = Array.isArray(plan) ? plan : [];

const recs = Array.isArray(allRecs) ? allRecs : [];
// Prefer date_local window; fall back to completed_at only if date_local missing.
state.records = recs.filter(r =>
  inWeekByDateLocal(r, ws) || (!r.date_local && inWeekByCompletedAt(r, ws))
);
    const agg=aggregate(state.records);
    const plannedTotal = state.plan.reduce((s,p)=> s + toNum(p.target_qty), 0);
    const appliedTotal = Array.from(agg.byPO.values()).reduce((s,v)=> s+v, 0);
    const pct = plannedTotal>0? Math.round(appliedTotal*100/plannedTotal) : (state.plan.length?0:100);
    $('#planned-range').textContent = `${ws} – ${we}`;
    $('#applied-range').textContent = `${ws} – ${we}`;
    $('#planned-total').textContent = fmtInt(plannedTotal);
    $('#applied-total').textContent = fmtInt(appliedTotal);
    $('#pct-week').textContent = `${pct}%`;
    $('#avg-week').textContent = fmtInt(appliedTotal);
    $('#avg-day').textContent = fmtInt(Math.round((appliedTotal||0)/7));
    renderCapsules(ws, plannedTotal, appliedTotal);
    setFooterHealth(pct, appliedTotal);

    const poRows = joinPOProgress(state.plan, agg.byPO);
    renderPOProgress(poRows);

    const riskPO = computeRisk(poRows.map(r=>({po:r.po,due:r.due,planned:r.planned,applied:r.applied})));
    // build per SKU progress
    const perSKU=new Map();
    for(const p of state.plan){
      const sku=String(p.sku_code||'').trim(); if(!sku) continue;
      const r=perSKU.get(sku)||{due:p.due_date,planned:0,applied:0};
      r.planned+=toNum(p.target_qty);
      if(r.due!==p.due_date) r.due = r.due < p.due_date ? r.due : p.due_date;
      perSKU.set(sku,r);
    }
    for(const [sku,v] of agg.bySKU.entries()){const r=perSKU.get(sku)||{due:'',planned:0,applied:0}; r.applied+=v; perSKU.set(sku,r);}
    const skuRows=Array.from(perSKU.entries()).map(([sku,r])=>({key:sku,due:r.due,planned:r.planned,applied:r.applied}));
    const riskSKU = computeRisk(skuRows);
    renderRisk(riskPO,'#risk-po-body');
    renderRisk(riskSKU,'#risk-sku-body');

// 👉 add/keep this:
renderInsights(state.records, state.plan, state.weekStart);

    // download buttons
    $('#btn-dl-posku').onclick=()=>{
      const rows=buildDiscrepancyPOSKU(state.plan, state.records);
      const csv=toCSV(['PO','SKU','Planned','Applied','Discrepancy (Applied - Planned)'], rows);
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'})); a.download=`po_sku_discrepancy_${ws}.csv`; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),250);
    };
    $('#btn-dl-po').onclick=()=>{
      const rows=buildDiscrepancyPO(poRows);
      const csv=toCSV(['PO','Planned','Applied','Discrepancy (Applied - Planned)'], rows);
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'})); a.download=`po_discrepancy_${ws}.csv`; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),250);
    };
    $('#btn-exec').onclick = () => {
  // week window
  const wsISO = state.weekStart;
  const weD = new Date(wsISO); weD.setDate(weD.getDate() + 6);
  const weISO = iso(weD);

  // KPIs
  const plannedTotal = (state.plan||[]).reduce((s,p)=> s + toNum(p.target_qty), 0);

  // records for this week are already filtered in state.records
  const recs = (state.records||[]).filter(r => r.status === 'complete');
  const appliedTotal = recs.length;
  const pct = plannedTotal>0 ? Math.round(appliedTotal*100/plannedTotal) : (state.plan.length?0:100);

  // ----- PO × SKU (planned + applied) -----
  const planPOSKU = new Map(); // "po||sku" -> planned
  for (const p of state.plan||[]) {
    const po = String(p.po_number||'').trim();
    const sku = String(p.sku_code||'').trim();
    if (!po || !sku) continue;
    const k = `${po}||${sku}`;
    planPOSKU.set(k, (planPOSKU.get(k)||0) + toNum(p.target_qty));
  }

  const appliedPOSKU = new Map(); // "po||sku" -> applied count
  for (const r of recs) {
    const po = String(r.po_number||'').trim();
    const sku = String(r.sku_code||'').trim();
    if (!po || !sku) continue;
    const k = `${po}||${sku}`;
    appliedPOSKU.set(k, (appliedPOSKU.get(k)||0) + 1);
  }

  const poskuRows = Array.from(appliedPOSKU.entries()).map(([k, applied]) => {
    const [po, sku] = k.split('||');
    const planned = planPOSKU.get(k) || 0;
    const pct = planned>0 ? Math.round(applied*100/planned) : 100;
    return { po, sku, planned, applied, pct };
  }).sort((a,b)=> b.applied - a.applied).slice(0, 50); // top 50 for readability

  // ----- Mobile bins -----
  const binUnits = new Map();   // bin -> units
  const binSkuSet = new Map();  // bin -> Set(sku)

  for (const r of recs) {
    const bin = String(r.mobile_bin||'').trim();
    const sku = String(r.sku_code||'').trim();
    if (!bin) continue;
    binUnits.set(bin, (binUnits.get(bin)||0) + 1);
    if (sku) {
      if (!binSkuSet.has(bin)) binSkuSet.set(bin, new Set());
      binSkuSet.get(bin).add(sku);
    }
  }
  const uniqueBins = binUnits.size;
  const topBins = Array.from(binUnits.entries())
    .map(([bin, units]) => ({ bin, units, uniqueSkus: (binSkuSet.get(bin)||new Set()).size }))
    .sort((a,b)=> b.units - a.units)
    .slice(0, 25); // top 25 bins

  // ----- Insights (concise) -----
  // 1) Top PO × SKU by volume
  const leadPOSKU = poskuRows[0];
  const insights = [];
  if (leadPOSKU) {
    insights.push(`Highest volume: PO ${leadPOSKU.po} × SKU ${leadPOSKU.sku} — ${leadPOSKU.applied.toLocaleString()} applied (${leadPOSKU.pct}% of ${leadPOSKU.planned.toLocaleString()} planned).`);
  }
  // 2) Bin diversity / leaders
  if (uniqueBins) {
    const tops = topBins.slice(0,5).map(b => `${b.bin} (${b.units.toLocaleString()})`).join(', ');
    insights.push(`Mobile bins used: ${uniqueBins.toLocaleString()} • Top bins by units: ${tops}.`);
  }
  // 3) Pacing vs plan
  const avgPerDay = Math.round(appliedTotal/7);
  const rem = Math.max(0, plannedTotal - appliedTotal);
  insights.push(`Pace: ~${avgPerDay.toLocaleString()}/day • Remaining vs plan: ${rem.toLocaleString()}.`);
  // 4) PO/SKU risk callout (reuse at-risk already computed on page if you want)
  //    Here, just pull any with remaining >0 (sorted outside) from existing tables would be ideal.

  // ----- Build & download -----
  const html = buildExecHTML({
    ws: wsISO, we: weISO,
    plannedTotal, appliedTotal, pct,
    uniqueBins,
    topPOSKU: poskuRows,
    topBins,
    insights
  });

  const blob = new Blob([html], { type: 'application/msword' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `VAS_Executive_Summary_${wsISO}.doc`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 250);
};

  // ---------- Plan upload / zero (unchanged) ----------
  $('#btn-upload-plan').onclick=()=>$('#file-plan').click();
$('#file-plan').addEventListener('change', async (e) => {
  const f = e.target.files?.[0];
  e.target.value = '';
  if (!f || !apiBase) return;

  const weekStart = $('#week-start').value;
  let rows = [];

  try {
    if (/\.xlsx?$/i.test(f.name)) {
      // Excel: read all rows using SheetJS
      const buf = await f.arrayBuffer();
      const wb = XLSX.read(buf, { type: 'array' });
      rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' });
    } else {
      // CSV: parse with SheetJS to avoid truncation/edge cases
      const buf = await f.arrayBuffer();
      const wb = XLSX.read(new Uint8Array(buf), { type: 'array' });
      rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' });
    }
  } catch (err) {
    console.error('Parsing failed', err);
    alert('Could not parse file');
    return;
  }

  if (!rows.length) return alert('No rows found.');

  // ---- Point B helpers ----
  const normalize = (r) => {
    const n = {};
    for (const k in r) n[k.toLowerCase().replace(/\s+/g, '_')] = r[k];
    return n;
  };


  // Convert Excel serials / Dates / strings -> YYYY-MM-DD


  const raw = rows.map(normalize);
  console.log('[plan-upload] parsed rows:', raw.length);

  const items = raw
    .map(r => ({
po_number: String(r.po_number ?? r.po ?? '').trim(),
sku_code:  String(r.sku_code  ?? r.sku  ?? '').trim(),
      start_date: weekStart,
      due_date: toISODate(r.due_date ?? r.due ?? ''),
      target_qty: toNum(r.target_qty ?? r.planned)
    }))
    // keep rows that at least have PO + SKU (server can validate due_date)
    .filter(r => r.po_number && r.sku_code);

  console.log('[plan-upload] valid rows (PO+SKU):', items.length);
  console.log('[plan-upload] rows with due_date:', items.filter(r => r.due_date).length);

const putRes = await fetch(`${apiBase}/plan/weeks/${weekStart}`, {
  method: 'PUT',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(items)
});
if (!putRes.ok) {
  const msg = await putRes.text().catch(() => 'Upload failed');
  alert(msg);
  return;
}

  alert(`Plan uploaded: ${items.length} rows`);
  setWeek(weekStart);
});
  $('#btn-zero-plan').onclick=async()=>{
    if(!apiBase) return alert('API not configured');
    const ws=$('#week-start').value;
    try{
      let r=await fetch(`${apiBase}/plan/weeks/${ws}/zero`,{method:'POST'});
      if(!r.ok&&r.status!==404){throw new Error(await r.text())}
      if(r.status===404){await fetch(`${apiBase}/plan/weeks/${ws}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:'[]'})}
      alert('Plan zeroed'); setWeek(ws);
    }catch(e){alert('Zero failed: '+(e.message||e))}
  };

  // ===================== INTAKE (same features you validated) =====================
  const intakeRows=[];
  function newRow(){return {id:crypto.randomUUID(), selected:false, date_local:iso(new Date()), mobile_bin:'', sscc_label:'', po_number:'', sku_code:'', uid:'', status:'draft', sync:'pending', _pending:{}};}
  function requiredFilled(r){return r.date_local && r.mobile_bin && r.po_number && r.sku_code && r.uid;}
  function syncClass(s){return s==='synced'?'bg-green-500':(s==='pending'?'bg-amber-500':'bg-gray-400');}
  function toIntakeRow(r){return {id:r.id, selected:false, date_local:r.date_local||iso(new Date()), mobile_bin:r.mobile_bin||'', sscc_label:r.sscc_label||'', po_number:r.po_number||'', sku_code:r.sku_code||'', uid:r.uid??'', status:r.status||'complete', sync:'synced', _pending:{}};}

  function renderIntake(){
    const tb=$('#intake-body'); tb.innerHTML='';
    if(!intakeRows.length) intakeRows.push(newRow());
    let drafts=0, synced=0;
    intakeRows.forEach((r,i)=>{
      const tr=document.createElement('tr'); tr.className=i%2?'bg-gray-50':'bg-white';
      if(r.status!=='complete') drafts++; else synced++;
      tr.innerHTML=`
        <td class="border px-2 py-2"><input type="checkbox" ${r.selected?'checked':''} data-id="${r.id}" data-role="sel"/></td>
        <td class="border px-2 py-2"><input class="cell" value="${toUI(r.date_local)}" data-id="${r.id}" data-f="date_local"/></td>
        <td class="border px-2 py-2"><input class="cell" value="${r.mobile_bin}" data-id="${r.id}" data-f="mobile_bin"/></td>
        <td class="border px-2 py-2"><input class="cell" value="${r.sscc_label}" data-id="${r.id}" data-f="sscc_label" placeholder="(optional)"/></td>
        <td class="border px-2 py-2"><input class="cell" value="${r.po_number}" data-id="${r.id}" data-f="po_number"/></td>
        <td class="border px-2 py-2"><input class="cell" value="${r.sku_code}" data-id="${r.id}" data-f="sku_code"/></td>
        <td class="border px-2 py-2"><input class="cell" value="${r.uid}" data-id="${r.id}" data-f="uid" data-last="1"/></td>
        <td class="border px-2 py-2 text-center"><span class="dot ${syncClass(r.sync)}"></span></td>`;
      tb.appendChild(tr);
    });

    tb.querySelectorAll('input[data-role="sel"]').forEach(chk=>{
      chk.addEventListener('change',e=>{
        const id=e.target.dataset.id; const row=intakeRows.find(x=>x.id===id); if(row){row.selected=e.target.checked;}
        $('#chk-all').checked = intakeRows.length && intakeRows.every(r=>r.selected);
      });
    });

    tb.querySelectorAll('input[data-f]').forEach(inp=>{
      const id=inp.dataset.id, f=inp.dataset.f;
      if(f==='uid'){
        inp.addEventListener('keydown',(ev)=>{
          if(ev.key==='Tab' && !ev.shiftKey){
            const idx=intakeRows.findIndex(x=>x.id===id);
            if(idx===intakeRows.length-1){ setTimeout(()=>{ intakeRows.push(newRow()); renderIntake(); },0); }
          }
        });
      }
      inp.addEventListener('input',e=>{
        const row=intakeRows.find(x=>x.id===id); if(!row) return;
        if (f === 'uid') {
  row[f] = String(e.target.value ?? '');
} else if (f === 'date_local') {
  row[f] = toISODate(String(e.target.value || '').trim());
} else {
  row[f] = String(e.target.value || '').trim();
} // UID verbatim
        row.status = requiredFilled(row) ? 'complete' : 'draft';
        row.sync = 'pending';
      });
      inp.addEventListener('change', async e=>{
        const row=intakeRows.find(x=>x.id===id); if(!row) return;
        if(!apiBase || !requiredFilled(row)){ renderIntake(); return; }
        try{
          const res=await fetch(`${apiBase}/records`,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
              id:row.id, date_local:row.date_local, mobile_bin:row.mobile_bin, sscc_label:row.sscc_label,
              po_number:row.po_number, sku_code:row.sku_code, uid:row.uid
            })
          });
          const j=await res.json().catch(()=>({}));
          if(res.ok && j.ok){ row.status='complete'; row.sync='synced'; }
          else { row.sync='pending'; }
        }catch{ row.sync='pending'; }
        renderIntake();
        await loadOpsMetrics(); await refreshDashboardTotals();
      });
    });

    // ribbon quick badges
    $('#ops-drafts').textContent = drafts;
    $('#ops-sync-badges').innerHTML =
      `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full border text-[11px] border-green-200 bg-green-50 text-green-700">synced: ${synced}</span>
       <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full border text-[11px] border-amber-200 bg-amber-50 text-amber-700">pending: ${drafts}</span>`;
  }

  $('#btn-add-row').onclick=()=>{intakeRows.push(newRow()); renderIntake();};
  $('#btn-delete-selected').onclick=async()=>{
    const selected=intakeRows.filter(r=>r.selected);
    if(!selected.length) return alert('Select at least one row.');
    if(!confirm(`Delete ${selected.length} row(s)?`)) return;

    if(apiBase){
      const pairs=selected.filter(r=>r.uid && r.sku_code).map(r=>({uid:r.uid, sku_code:r.sku_code}));
      if(pairs.length){
        try{ await fetch(`${apiBase}/records/delete`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(pairs)}); }catch(e){ console.warn('Server delete error',e); }
      }
    }
    for(let i=intakeRows.length-1;i>=0;i--){ if(intakeRows[i].selected) intakeRows.splice(i,1); }
    if(!intakeRows.length) intakeRows.push(newRow());
    renderIntake();
    await loadOpsMetrics(); await refreshDashboardTotals();
  };
  $('#btn-export-day').onclick=()=>{ if(!apiBase) return; const d=iso(new Date()); window.location=`${apiBase}/export/xlsx?date=${d}`; };

function toISODate(v) {
  if (v == null || v === '') return '';
  if (typeof v === 'number') {
    const d = new Date(Math.round((v - 25569) * 86400 * 1000));
    return d.toISOString().slice(0, 10);
  }
  if (v instanceof Date) return v.toISOString().slice(0, 10);
  const str = String(v).trim();
  const m = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (m) {
    const [_, d, mth, y] = m;
    const yyyy = y.length === 2 ? '20' + y : y;
    return `${yyyy}-${mth.padStart(2, '0')}-${d.padStart(2, '0')}`;
  }
  const d2 = new Date(str);
  return isNaN(d2) ? '' : d2.toISOString().slice(0, 10);
}

  // Upload UIDs → table → sync (unchanged)
  (function wireUploadUIDs(){
    const btn=$('#btn-upload-applied'), file=$('#file-upload-applied');
    btn.onclick=()=>file.click();
    file.addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; e.target.value=''; if(!f) return;
      try{
        let rows=[];
        if(/\.xlsx?$/i.test(f.name)){
          const buf=await f.arrayBuffer(); const wb=XLSX.read(buf,{type:'array'}); const ws=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:''}); rows=ws;
        }else{
          const text=await f.text(); const lines=text.split(/\r?\n/).filter(Boolean);
          const hdr=lines.shift().split(',').map(s=>s.trim()); rows=lines.map(l=>l.split(',')).map(c=>{const o={};hdr.forEach((h,i)=>o[h]=c[i]??'');return o;});
        }
        const normRow=(r)=>{const n={}; for(const k in r){n[k.toLowerCase().replace(/\s+/g,'_')]=r[k];}
          const pick=(...a)=>{for(const x of a){const v=n[x]; if(v!=null && String(v).trim()!=='') return String(v).trim();} return '';}
          const pickRaw=(...a)=>{for(const x of a){ if(x in n) return String(n[x]??''); } return '';}
          return {
  date_local: toISODate(pick('date_local','date')),
  mobile_bin: pick('mobile_bin','mobile_bin_(box)','mobile_bin (box)'),
  sscc_label: pick('sscc_label','sscc','sscc_label (box)'),
  po_number: pick('po_number','po','po#'),
  sku_code:  pick('sku_code','sku'),
  uid:       pickRaw('uid','u_id','u id')
};

};
        const items = rows.map(normRow).filter(r=>r.po_number && r.sku_code && (r.uid!==''));
        if(!items.length) return alert('No valid rows found (need PO_Number, SKU_Code, UID).');

        for(const r of items){
          const ui=newRow();
          ui.date_local = r.date_local || iso(new Date()); // r.date_local is already YYYY-MM-DD
          ui.mobile_bin=r.mobile_bin||'';
          ui.sscc_label=r.sscc_label||'';
          ui.po_number=r.po_number;
          ui.sku_code=r.sku_code;
          ui.uid=r.uid; // verbatim
          ui.status=requiredFilled(ui)?'complete':'draft';
          ui.sync='pending';
          intakeRows.push(ui);

          if(requiredFilled(ui) && apiBase){
            try{
              const res=await fetch(`${apiBase}/records`,{method:'POST',headers:{'Content-Type':'application/json'},
                body:JSON.stringify({id:ui.id,date_local:ui.date_local,mobile_bin:ui.mobile_bin,sscc_label:ui.sscc_label,po_number:ui.po_number,sku_code:ui.sku_code,uid:ui.uid})});
              const j=await res.json().catch(()=>({})); if(res.ok && j.ok){ui.sync='synced'; ui.status='complete';}
            }catch{}
          }
        }
        renderIntake();
        await loadOpsMetrics(); await refreshDashboardTotals();
      }catch(err){ console.error(err); alert('Upload failed: '+(err?.message||err)); }
    });
  })();

  // ---------- Ops metrics & Ops Pulse ----------
  function todayISO(){const d=new Date(); d.setHours(0,0,0,0); return iso(d);}
async function loadOpsMetrics() {
  if (!apiBase) return;
  try {
    // Fetch all recent completed records, up to 50k
    const res = await fetch(`${apiBase}/records?status=complete&limit=50000`);
    if (!res.ok) throw new Error(await res.text());
    const rows = (await res.json()).records || [];

    const now = Date.now();
    const startToday = new Date();
    startToday.setHours(0, 0, 0, 0);
    const hourAgo = now - 3600e3;
    const halfAgo = now - 1800e3;

    let scansToday = 0, lastHour = 0, rate = 0, drafts = 0, dupes = 0;
    const syncCounts = {}, seen = new Set();

    for (const r of rows) {
      const ct = r.completed_at ? new Date(r.completed_at).getTime() : null;
      const todayByCompletion = !!ct && ct >= startToday.getTime();

      if (r.status === 'complete') {
        if (todayByCompletion) scansToday++;
        if (ct && ct >= hourAgo) lastHour++;
        if (ct && ct >= halfAgo) rate++;
        if (r.sku_code && r.uid) {
          const k = r.sku_code + '|' + r.uid;
          if (seen.has(k)) dupes++;
          else seen.add(k);
        }
      } else drafts++;

      const s = r.sync_state || 'unknown';
      syncCounts[s] = (syncCounts[s] || 0) + 1;
    }

    $('#ops-today').textContent = scansToday.toLocaleString();
    $('#ops-hour').textContent = lastHour.toLocaleString();
    $('#ops-rate').textContent = (rate * 2).toLocaleString();
    $('#ops-drafts').textContent = drafts.toLocaleString();
    $('#ops-dupes').textContent = dupes.toLocaleString();
    $('#ops-last-updated').textContent = new Date().toLocaleTimeString();

    // Pulse animation + hearts
    const bpm = Math.max(40, Math.min(200, rate * 2));
    $('#intake-bpm').textContent = bpm;

    const small = $('#ops-heart-small');
    if (small) {
      small.innerHTML = '';
      small.appendChild(createHeart(18, BRAND, bpm));
    }

    const big = $('#ops-heart');
    if (big) {
      big.innerHTML = '';
      big.appendChild(createHeart(24, BRAND, bpm));
      $('#ops-bpm').textContent = bpm;
      const delta = bpm - 40;
      $('#ops-extra').textContent = `${delta >= 0 ? '+' : ''}${delta} over 40`;
    }

    const wrap = $('#ops-sync-badges');
    if (wrap) {
      wrap.innerHTML = '';
      Object.entries(syncCounts)
        .sort((a, b) => b[1] - a[1])
        .forEach(([name, count]) => {
          const span = document.createElement('span');
          span.className =
            'inline-flex items-center gap-1 px-2 py-0.5 rounded-full border text-[11px] ' +
            (name === 'synced'
              ? 'border-green-200 bg-green-50 text-green-700'
              : name === 'pending'
              ? 'border-amber-200 bg-amber-50 text-amber-700'
              : 'border-gray-200 bg-gray-50 text-gray-700');
          span.textContent = `${name}: ${count}`;
          wrap.appendChild(span);
        });
    }

    const alerts = [];
    if (drafts > 0)
      alerts.push(
        `There ${drafts === 1 ? 'is' : 'are'} ${drafts} draft${
          drafts === 1 ? '' : 's'
        } to complete.`
      );
    if (dupes > 0)
      alerts.push(`${dupes} duplicate UID${dupes === 1 ? '' : 's'} detected today.`);
    $('#ops-alerts').innerHTML = alerts.length
      ? alerts.map((t) => `<li>${t}</li>`).join('')
      : '<li class="text-gray-400">No alerts.</li>';
  } catch (e) {
    console.warn('Ops ribbon metrics load failed:', e);
  }
}

  function startSSE(){
    if(!apiBase) return;
    try{
      const ev=new EventSource(`${apiBase}/events/scan`);
      $('#ops-dot')?.classList.replace('bg-gray-300','bg-green-500');
      ev.onmessage=async()=>{ await loadOpsMetrics(); await refreshDashboardTotals(); };
      ev.onerror = ()=>{ try{ev.close();}catch{}; $('#ops-dot')?.classList.replace('bg-green-500','bg-amber-500'); setTimeout(startSSE,3000); };
    }catch{}
  }

  // ---------- Dashboard weekly refresh from completion timestamps ----------
  async function refreshDashboardTotals(){
    if(!apiBase) return;
    const ws=state.weekStart;
    const start = new Date(ws + 'T00:00:00');   // local midnight
const end   = new Date(start); 
end.setDate(end.getDate() + 7);

    const res=await fetch(`${apiBase}/records?limit=50000`);
    if(!res.ok) return;
    const all=(await res.json()).records||[];

const inWeek = all.filter(r => {
if (r.status !== 'complete') return false;
if (r.completed_at) {
const t = new Date(r.completed_at).getTime();
return t >= start.getTime() && t < end.getTime();
}
// Fallback: use date_local window if completed_at missing
const ws = state.weekStart;           // YYYY-MM-DD
const weD = new Date(ws); weD.setDate(weD.getDate() + 6);
const we = iso(weD);
const dl = toISODate(r.date_local); // normalizes "06-10-2025", "6/10/25", Excel serials, etc.
return dl && dl >= ws && dl <= we;
});

    const appliedTotal=inWeek.length;
    const plannedTotal=(state.plan||[]).reduce((s,p)=>s+toNum(p.target_qty),0);
    const pct = plannedTotal>0?Math.round(appliedTotal*100/plannedTotal):(state.plan.length?0:100);

    $('#planned-total').textContent = plannedTotal.toLocaleString();
    $('#applied-total').textContent = appliedTotal.toLocaleString();
    $('#pct-week').textContent = pct+'%';
    $('#avg-week').textContent = appliedTotal.toLocaleString();
    $('#avg-day').textContent = Math.round((appliedTotal||0)/7).toLocaleString();
    setFooterHealth(pct, appliedTotal);
    renderCapsules(ws, plannedTotal, appliedTotal);
  }

  // ---------- Simple Search ----------
  (function attachSearch(){
    const el=$('#search-input'); if(!el) return; let t=null;
    el.addEventListener('input',(e)=>{
      clearTimeout(t);
      t=setTimeout(()=>{
        const term=String(e.target.value||'').trim();
        const wrap=$('#search-results'); if(!term){wrap.classList.add('hidden'); wrap.innerHTML=''; return;}
        const agg=aggregate(state.records); const rows=[];
        const plannedPO=state.plan.filter(p=>String(p.po_number).trim()===term).reduce((s,p)=>s+toNum(p.target_qty),0);
        let appliedPO=0; for(const [k,v] of agg.byPO.entries()){ if(k===term) appliedPO+=v; }
        if(plannedPO||appliedPO) rows.push({scope:'PO',planned:plannedPO,applied:appliedPO,pct:plannedPO>0?Math.round((appliedPO/plannedPO)*100):0});
        const plannedSKU=state.plan.filter(p=>String(p.sku_code).trim()===term).reduce((s,p)=>s+toNum(p.target_qty),0);
        let appliedSKU=0; for(const [k,v] of agg.bySKU.entries()){ if(k===term) appliedSKU+=v; }
        if(plannedSKU||appliedSKU) rows.push({scope:'SKU',planned:plannedSKU,applied:appliedSKU,pct:plannedSKU>0?Math.round((appliedSKU/plannedSKU)*100):0});
        wrap.classList.remove('hidden');
        wrap.innerHTML = rows.length ? rows.map(r=>`<div class="bg-gray-50 rounded-xl p-3 border"><div class="text-xs text-gray-500">${r.scope}</div><div class="text-sm mt-1">Planned: ${fmtInt(r.planned)} · Applied: ${fmtInt(r.applied)} · ${r.pct}%</div></div>`).join('') : '<div class="text-xs text-gray-500">No matches in this week.</div>';
      },300);
    });
  })();

  // ---------- Routing & Init ----------
  (function init(){
    const ws=iso(mondayOf()); $('#week-start').value=ws;
    setWeek(ws);
    function show(hash){ $('#page-dashboard').classList.add('hidden'); $('#page-intake').classList.add('hidden'); (hash==='#intake'?$('#page-intake'):$('#page-dashboard')).classList.remove('hidden'); }
    window.addEventListener('hashchange',()=>show(location.hash||'#dashboard')); show(location.hash||'#dashboard');
    // intake scaffold
    renderIntake();

  // Select All checkbox (header)
  document.getElementById('chk-all')?.addEventListener('change', (e) => {
    const on = e.target.checked;
    intakeRows.forEach(r => r.selected = on);
    renderIntake();
    // keep header checkbox visually in sync after re-render
    document.getElementById('chk-all').checked = on;
  });

    // hearts / metrics
    $('#ops-heart').appendChild(createHeart(24,BRAND,40));
    $('#ops-heart-small').appendChild(createHeart(18,BRAND,40));
    loadOpsMetrics(); startSSE();
  })();


  </script>
</body>
</html>